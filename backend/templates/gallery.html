{% extends 'base.html' %}
{% block content %}
<div class="gallery-device-frame mx-auto my-4">
  <div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h1 class="fw-bold mb-0" style="letter-spacing:1px;">School Gallery</h1>
      {% if user.is_authenticated %}
      <a href="{% url 'gallery_upload' %}" class="btn btn-primary"><i class="bi bi-cloud-upload"></i> Upload</a>
      {% endif %}
    </div>
    <div class="row g-4" id="galleryGrid">
        {% for item in gallery_items %}
        <div class="col-12">
            <div class="card fb-card shadow-sm border-0 h-100 mb-4 bg-white" data-id="{{ item.id }}" data-img-url="{% if item.media_type == 'video' %}{{ item.media_url }}{% else %}{{ item.image.url }}{% endif %}" data-caption="{{ item.caption|escapejs }}" data-description="{{ item.description|escapejs }}" data-category="{{ item.category|escapejs }}" data-upload="{{ item.upload_date|date:'M d, Y' }}">
                <div class="card-header d-flex align-items-center bg-white border-0 pb-0">
                    {% if item.uploader %}
                      <span class="avatar me-2">{{ item.uploader.get_full_name|default:item.uploader.username|first|default:"A" }}</span>
                      <div>
                        <div class="fw-semibold">{{ item.uploader.get_full_name|default:item.uploader.username|default:"Admin" }}</div>
                        <div class="text-muted small">{{ item.upload_date|date:'M d, Y' }}</div>
                      </div>
                    {% else %}
                      <span class="avatar me-2">A</span>
                      <div>
                        <div class="fw-semibold">Admin</div>
                        <div class="text-muted small">{{ item.upload_date|date:'M d, Y' }}</div>
                      </div>
                    {% endif %}
                </div>
                <!-- Add heart animation overlay -->
                <div class="gallery-img-wrapper px-2 pt-2 position-relative">
                  {% if item.media_type == 'video' %}
                  <video src="{{ item.media_url }}" class="gallery-img-fb" controls preload="metadata">
                    Your browser does not support the video tag.
                  </video>
                  <span class="badge bg-danger position-absolute top-0 end-0 m-3"><i class="bi bi-camera-video"></i> Video</span>
                  {% else %}
                  {% if item.image %}
                  <img src="{{ item.image.url }}" class="gallery-img-fb" alt="{{ item.caption }}">
                  {% else %}
                  <div class="text-center p-5 bg-light">No image available</div>
                  {% endif %}
                  {% endif %}
                  <div class="heart-anim-overlay position-absolute top-50 start-50 translate-middle" style="display:none;pointer-events:none;">
                    <i class="bi bi-heart-fill" style="font-size:3.5rem;color:#e0245e;"></i>
                  </div>
                  <div class="floating-heart-container position-absolute start-50 translate-middle-x" style="bottom:10px;left:50%;pointer-events:none;z-index:11;"></div>
                </div>
                <div class="card-body pt-2 pb-1">
                    <h5 class="card-title fw-semibold mb-2">{{ item.caption }}</h5>
                    <p class="card-text text-muted mb-2 description-preview" style="min-height:2.5em;">
                        {% if item.description|length > 120 %}
                            {{ item.description|slice:":120" }}... <a href="#" class="see-more-link">See more</a>
                        {% else %}
                            {{ item.description }}
                        {% endif %}
                    </p>
                    <span class="badge bg-gradient bg-primary">{{ item.category }}</span>
                </div>
                <div class="card-footer bg-white border-0 pt-0 pb-2">
                    <div class="d-flex align-items-center justify-content-between mt-2">
                        <div class="insta-like-bar" data-id="{{ item.id }}">
                            <button class="btn btn-light btn-sm insta-like-btn" data-liked="false">
                                <i class="bi bi-heart"></i> <span class="like-count">0</span>
                            </button>
                        </div>
                        <div>
                            <button class="btn btn-light btn-sm insta-comment-btn" data-id="{{ item.id }}" style="padding:0.25em 0.7em;">
                                <i class="bi bi-chat-left"></i> <span class="comment-count">{{ item.comment_count|default:0 }}</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% empty %}
        <div class="col-12">
            <div class="alert alert-info text-center">No gallery items found.</div>
        </div>
        {% endfor %}
    </div>
    <div id="loadingSpinner" class="text-center my-4" style="display:none;">
        <div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div>
    </div>
  </div>
</div>

<!-- Toast notification -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1100">
  <div id="toastNotif" class="toast align-items-center text-bg-primary border-0" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="d-flex">
      <div class="toast-body" id="toastNotifBody"></div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
  </div>
</div>

<!-- Facebook-style Mobile Modal -->
<div class="modal fade" id="galleryModal" tabindex="-1" aria-labelledby="galleryModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content fb-modal-content border-0">
      <button type="button" class="btn-close btn-close-white position-absolute top-0 end-0 m-3" data-bs-dismiss="modal" aria-label="Close" style="z-index:10;"></button>
      <div class="fb-modal-img-wrapper bg-black d-flex align-items-center justify-content-center">
        <!-- Media container that will show either image or video -->
        <div id="modalMediaContainer" class="w-100 h-100 d-flex align-items-center justify-content-center">
          <img id="modalImage" src="" class="img-fluid fb-modal-img" alt="" style="display:none;">
          <video id="modalVideo" src="" class="img-fluid fb-modal-img" controls preload="metadata" style="display:none;"></video>
        </div>
      </div>
      <div class="fb-modal-body p-3">
        <div class="d-flex align-items-center mb-2">
          <span class="avatar me-2">A</span>
          <div>
            <div class="fw-semibold text-dark">Anonymous</div>
            <div class="text-muted small" id="modalUpload"></div>
          </div>
        </div>
        <h5 class="fw-semibold text-dark mb-2" id="galleryModalLabel"></h5>
        <p class="mb-1 text-dark fs-6" id="modalDescription"></p>
        <span class="badge bg-gradient bg-primary mb-2" id="modalCategory"></span>
        <div class="d-flex justify-content-start align-items-center gap-2 mb-2 modal-like-bar">
          <button class="btn btn-light btn-sm modal-like-btn" data-liked="false">
            <i class="bi bi-heart"></i> <span class="like-count" id="modalLikeCount">0</span>
          </button>
        </div>
        <span class="text-secondary small"><i class="bi bi-chat-left"></i> <span id="modalCommentCount">0</span> Comments</span>
        <div class="comments-section mt-3 bg-light rounded-3 p-3 mx-auto" style="max-width:100%;">
          <h6 class="text-muted mb-3">Comments</h6>
          <div id="commentsList" class="mb-3" style="max-height:200px; overflow-y:auto;"></div>
          <!-- Modern comment box -->
<form id="commentForm" class="d-flex align-items-center gap-2 mt-2 position-relative" autocomplete="off">
  <span class="avatar" style="width:32px;height:32px;font-size:1.1rem;">{{ user_name|first|default:'A' }}</span>
  <input type="text" class="form-control rounded-pill shadow-sm" id="commentText" placeholder="Add a comment..." required style="flex:1; min-height:2.3em; border:1.5px solid #e3e9f7; background:#f7faff;">
  <button type="submit" id="sendCommentBtn" class="btn btn-primary rounded-circle d-flex align-items-center justify-content-center shadow-sm" style="width:38px;height:38px; position:relative;" disabled><i class="bi bi-send"></i></button>
</form>
        </div>
      </div>
    </div>
  </div>
</div>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
<style>
body {
    background: #f0f2f5 !important;
}
.gallery-device-frame {
    background: #fff;
    border-radius: 32px;
    box-shadow: 0 8px 32px rgba(60,60,120,0.13);
    max-width: 430px;
    min-height: 90vh;
    margin: 2rem auto;
    overflow: hidden;
    border: 1.5px solid #e3e9f7;
    position: relative;
}
.fb-card {
    border-radius: 14px;
    box-shadow: 0 2px 8px rgba(60,60,120,0.08);
    overflow: hidden;
    margin-bottom: 2rem;
}
.card-header {
    background: #fff;
    border-bottom: none;
    padding-bottom: 0.25rem;
}
.avatar {
    width: 40px; height: 40px; border-radius: 50%; display: inline-block; background: #e3e9f7; color: #23243a; font-weight: bold; text-align: center; line-height: 40px; font-size: 1.2rem;
}
.gallery-img-wrapper {
    background: #f4f6fb;
    border-radius: 12px;
    overflow: hidden;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0.5rem 0;
}
.gallery-img-fb {
    object-fit: cover;
    width: 100%;
    max-height: 350px;
    border-radius: 12px;
    background: #f4f6fb;
    display: block;
    margin: auto;
}
.card-body {
    background: #fff;
    padding-bottom: 0.5rem;
}
.card-footer {
    background: #fff;
    border-top: none;
}
.reaction-bar button {
    margin-right: 0.15rem;
}
.see-more-link {
    color: #1877f2;
    cursor: pointer;
    text-decoration: none;
}
.see-more-link:hover {
    text-decoration: underline;
}
.fb-modal-content {
    border-radius: 18px;
    box-shadow: 0 8px 32px rgba(0,0,0,0.25);
    background: #fff !important;
    overflow: hidden;
    max-width: 480px;
    margin: auto;
    position: relative;
}
.fb-modal-img-wrapper {
    background: #000;
    width: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0;
}
.fb-modal-img {
    object-fit: contain;
    width: 100%;
    max-height: 350px;
    border-radius: 0 0 12px 12px;
    background: #222;
    display: block;
    margin: auto;
}
.fb-modal-body {
    background: #fff;
    border-radius: 0 0 18px 18px;
    box-shadow: none;
}
.comments-section {
    background: #f7f7fa !important;
}
.toast {
    min-width: 200px;
}
.heart-anim-overlay {
  z-index: 10;
  opacity: 0;
  transition: opacity 0.2s;
}
.heart-anim-overlay.show {
  opacity: 1;
  animation: heart-pop 0.7s cubic-bezier(.23,1.12,.67,1.01);
}
@keyframes heart-pop {
  0% { transform: scale(0.7) translate(-50%,-50%); opacity: 0; }
  30% { transform: scale(1.2) translate(-50%,-50%); opacity: 1; }
  60% { transform: scale(1) translate(-50%,-50%); opacity: 1; }
  100% { transform: scale(1) translate(-50%,-50%); opacity: 0; }
}
.floating-heart {
  position: absolute;
  left: 50%;
  transform: translateX(-50%) scale(1);
  font-size: 2.2rem;
  color: #e0245e;
  opacity: 0.95;
  animation: float-heart 1.1s cubic-bezier(.23,1.12,.67,1.01) forwards;
  pointer-events: none;
}
@keyframes float-heart {
  0% { bottom: 0; opacity: 0.95; transform: translateX(-50%) scale(1.2); }
  60% { opacity: 1; transform: translateX(-50%) scale(1.1); }
  80% { opacity: 1; }
  100% { bottom: 60px; opacity: 0; transform: translateX(-50%) scale(1); }
}
.insta-like-btn.liked, .modal-like-btn.liked {
  color: #e0245e;
  background: #ffe6ef;
}
.insta-like-btn.liked i, .modal-like-btn.liked i {
  color: #e0245e;
}
.insta-like-btn.like-bounce, .modal-like-btn.like-bounce {
  animation: like-bounce 0.4s cubic-bezier(.23,1.12,.67,1.01);
}
@keyframes like-bounce {
  0% { transform: scale(1); }
  30% { transform: scale(1.3); }
  60% { transform: scale(0.95); }
  100% { transform: scale(1); }
}
.small-heart-below {
  display: block;
  text-align: center;
  color: #e0245e;
  font-size: 1.3rem;
  margin-top: 0.2em;
  opacity: 0;
  animation: show-small-heart 1.1s forwards;
}
@keyframes show-small-heart {
  0% { opacity: 0; transform: scale(0.7); }
  30% { opacity: 1; transform: scale(1.2); }
  60% { opacity: 1; transform: scale(1); }
  100% { opacity: 0; transform: scale(1); }
}
.insta-like-btn .bi-heart-fill, .modal-like-btn .bi-heart-fill {
  color: #e0245e;
}
#commentText {
  border-radius: 999px !important;
  padding-left: 1.1em;
  padding-right: 1.1em;
}
#commentsList .comment-bubble {
  display: flex;
  align-items: flex-start;
  gap: 0.7em;
  margin-bottom: 1em;
  animation: fadeInComment 0.4s;
}
#commentsList .comment-bubble .avatar {
  width: 32px; height: 32px; font-size: 1.1rem;
}
#commentsList .comment-bubble .bubble {
  background: #f0f2f5;
  border-radius: 16px;
  padding: 0.7em 1.1em;
  min-width: 60px;
  max-width: 80%;
  color: #222;
  font-size: 1.04em;
  box-shadow: 0 2px 8px #2F80ED0A;
}
@keyframes fadeInComment {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}
.comment-card {
  background: #fff;
  border-radius: 14px;
  box-shadow: 0 2px 8px #2F80ED0A;
  padding: 0.7em 1em 0.7em 0.7em;
  margin-bottom: 0.7em;
  display: flex;
  align-items: flex-start;
  min-height: 48px;
}
.comment-avatar-img {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  object-fit: cover;
  background: #e3e9f7;
  border: 1.5px solid #e3e9f7;
}
.avatar.comment-avatar-fallback {
  width: 36px;
  height: 36px;
  font-size: 1.1rem;
  display: flex;
  align-items: center;
  justify-content: center;
  background: #e3e9f7;
  color: #23243a;
  font-weight: bold;
  border-radius: 50%;
}
.comment-text {
  font-size: 1.04em;
  color: #222;
  word-break: break-word;
}
.tiny {
  font-size: 0.78em;
}
</style>

<script>
let galleryPage = 1;
let galleryLoading = false;
let galleryHasNext = true;

function renderGalleryItems(items) {
    const grid = document.getElementById('galleryGrid');
    for (const item of items) {
        const col = document.createElement('div');
        col.className = 'col-12';
        
        // Determine if it's a video or image
        const isVideo = item.media_type === 'video';
        const mediaUrl = item.media_url || item.image_url;
        
        // Create media element based on type
        let mediaElement = '';
        if (isVideo) {
            mediaElement = `
            <div class="gallery-img-wrapper px-2 pt-2">
                <video src="${mediaUrl}" class="gallery-img-fb" controls preload="metadata">
                    Your browser does not support the video tag.
                </video>
                <span class="badge bg-danger position-absolute top-0 end-0 m-3"><i class="bi bi-camera-video"></i> Video</span>
            </div>`;
        } else {
            mediaElement = `
            <div class="gallery-img-wrapper px-2 pt-2">
                <img src="${mediaUrl}" class="gallery-img-fb" alt="${item.caption}">
            </div>`;
        }
        
        col.innerHTML = `
        <div class="card fb-card shadow-sm border-0 h-100 mb-4 bg-white" 
            data-id="${item.id}" 
            data-media-url="${mediaUrl}" 
            data-media-type="${isVideo ? 'video' : 'image'}" 
            data-caption="${item.caption}" 
            data-description="${item.description}" 
            data-category="${item.category}" 
            data-upload="${item.upload_date}">
            <div class="card-header d-flex align-items-center bg-white border-0 pb-0">
                <span class="avatar me-2">A</span>
                <div>
                    <div class="fw-semibold">Anonymous</div>
                    <div class="text-muted small">${item.upload_date}</div>
                </div>
            </div>
            ${mediaElement}
            <div class="card-body pt-2 pb-1">
                <h5 class="card-title fw-semibold mb-2">${item.caption}</h5>
                <p class="card-text text-muted mb-2 description-preview" style="min-height:2.5em;">
                    ${item.description.length > 120 ? item.description.slice(0,120) + '...' : item.description}
                    <a href="#" class="see-more-link">See more</a>
                </p>
                <span class="badge bg-gradient bg-primary">${item.category}</span>
            </div>
            <div class="card-footer bg-white border-0 pt-0 pb-2">
                <div class="d-flex align-items-center justify-content-between mt-2">
                    <div class="insta-like-bar" data-id="${item.id}">
                        <button class="btn btn-light btn-sm insta-like-btn" data-liked="false">
                            <i class="bi bi-heart"></i> <span class="like-count">0</span>
                        </button>
                    </div>
                    <div>
                        <span class="text-secondary small"><i class="bi bi-chat-left"></i> <span class="comment-count">${item.comment_count}</span> Comments</span>
                    </div>
                </div>
            </div>
        </div>`;
        grid.appendChild(col);
    }
}

function loadMoreGallery() {
    if (!galleryHasNext || galleryLoading) return;
    galleryLoading = true;
    document.getElementById('loadingSpinner').style.display = '';
    fetch(`/gallery/?page=${galleryPage+1}`, {headers: {'x-requested-with':'XMLHttpRequest'}})
        .then(res => res.json())
        .then(data => {
            renderGalleryItems(data.gallery);
            galleryHasNext = data.has_next;
            galleryPage++;
            galleryLoading = false;
            document.getElementById('loadingSpinner').style.display = 'none';
            updateAllLikeBars();
        });
}

window.addEventListener('scroll', function() {
    if ((window.innerHeight + window.scrollY) >= (document.body.offsetHeight - 300)) {
        loadMoreGallery();
    }
});

function showToast(msg) {
    document.getElementById('toastNotifBody').textContent = msg;
    const toast = new bootstrap.Toast(document.getElementById('toastNotif'));
    toast.show();
}

function decodeHtmlEntities(str) {
    var txt = document.createElement('textarea');
    txt.innerHTML = str;
    return txt.value;
}

// Replace all reaction logic with single like (heart)
function updateLikeBar(bar, id) {
  fetch(`/api/gallery/${id}/likes/`).then(r=>r.json()).then(d=>{
    bar.querySelector('.like-count').textContent = d.counts.like;
    const btn = bar.querySelector('.insta-like-btn');
    if (d.liked) {
      btn.classList.add('liked');
      btn.setAttribute('data-liked', 'true');
      btn.querySelector('i').className = 'bi bi-heart-fill';
    } else {
      btn.classList.remove('liked');
      btn.setAttribute('data-liked', 'false');
      btn.querySelector('i').className = 'bi bi-heart';
    }
  });
}
function updateAllLikeBars() {
  document.querySelectorAll('.insta-like-bar').forEach(bar => {
    const id = bar.getAttribute('data-id');
    updateLikeBar(bar, id);
  });
}
setInterval(updateAllLikeBars, 10000);

// See more/less for description
function toggleSeeMore(e) {
    e.preventDefault();
    const p = e.target.closest('.description-preview');
    if (!p) return;
    if (e.target.textContent === 'See more') {
        p.textContent = p.dataset.fulltext;
        e.target.textContent = 'See less';
    } else {
        p.textContent = p.dataset.shorttext;
        e.target.textContent = 'See more';
    }
}
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.description-preview').forEach(function(p) {
        const full = p.textContent;
        if (full.length > 120) {
            p.dataset.fulltext = full;
            p.dataset.shorttext = full.slice(0, 120) + '...';
            p.innerHTML = p.dataset.shorttext + ' <a href="#" class="see-more-link">See more</a>';
        }
    });
    document.body.addEventListener('click', function(e) {
        if (e.target.classList.contains('see-more-link')) {
            toggleSeeMore(e);
        }
    });
    // Modal logic
    let currentGalleryId = null;
    const galleryModal = new bootstrap.Modal(document.getElementById('galleryModal'));
    function openModal(card) {
        currentGalleryId = card.getAttribute('data-id');
        document.getElementById('galleryModal').setAttribute('data-current-id', currentGalleryId);
        
        // Determine media type and show appropriate element
        const mediaType = card.getAttribute('data-media-type') || 'image';
        const mediaUrl = card.getAttribute('data-media-url') || card.getAttribute('data-img-url');
        
        if (mediaType === 'video') {
            document.getElementById('modalVideo').src = mediaUrl;
            document.getElementById('modalVideo').style.display = 'block';
            document.getElementById('modalImage').style.display = 'none';
        } else {
            document.getElementById('modalImage').src = mediaUrl;
            document.getElementById('modalImage').style.display = 'block';
            document.getElementById('modalVideo').style.display = 'none';
        }
        
        document.getElementById('galleryModalLabel').textContent = decodeHtmlEntities(card.getAttribute('data-caption'));
        document.getElementById('modalDescription').textContent = decodeHtmlEntities(card.getAttribute('data-description'));
        document.getElementById('modalCategory').textContent = decodeHtmlEntities(card.getAttribute('data-category'));
        document.getElementById('modalUpload').textContent = 'Uploaded: ' + card.getAttribute('data-upload');
        // Load reactions
        fetch(`/api/gallery/${currentGalleryId}/likes/`).then(r=>r.json()).then(d=>{
            document.getElementById('modalLikeCount').textContent = d.counts.like;
        });
        // Load comments
        fetch(`/api/gallery/${currentGalleryId}/comments/`).then(r=>r.json()).then(d=>{
            document.getElementById('modalCommentCount').textContent = d.comments.length;
            const list = document.getElementById('commentsList');
            list.innerHTML = '';
            for (const c of d.comments) {
                let avatarHtml = '';
                if (c.profile_pic) {
                    avatarHtml = `<img src='${c.profile_pic}' class='comment-avatar-img' alt='profile' />`;
                } else {
                    avatarHtml = `<span class='avatar comment-avatar-fallback'>${c.name ? c.name[0].toUpperCase() : 'A'}</span>`;
                }
                const div = document.createElement('div');
                div.className = 'comment-card';
                div.innerHTML = `
                    <div class='d-flex align-items-center gap-2'>
                        ${avatarHtml}
                        <div class='flex-grow-1'>
                            <div class='fw-semibold small mb-1'>${c.name}</div>
                            <div class='comment-text'>${c.comment}</div>
                            <div class='text-muted tiny mt-1'>${c.created_at}</div>
                        </div>
                    </div>
                `;
                list.appendChild(div);
            }
        });
        galleryModal.show();
    }
    // Remove modal open from body click handler for .fb-card
    document.body.addEventListener('click', function(e) {
      // Only handle like button in card
      if (e.target.closest('.insta-like-btn')) {
        const bar = e.target.closest('.insta-like-bar');
        const id = bar.getAttribute('data-id');
        fetch(`/api/gallery/${id}/likes/`, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({reaction:'like'})})
          .then(r=>r.json()).then(d=>{
            updateLikeBar(bar, id);
            showToast(d.liked ? 'You liked this!' : 'Like removed');
          });
      }
    });
    // Single vs double click on image: single opens modal, double likes
    document.querySelectorAll('.gallery-img-fb').forEach(img => {
      let lastTap = 0;
      let clickTimer = null;
      let lastTouch = 0;
      let touchTimer = null;
      let touchPreventClick = false;
      // Desktop: click
      img.addEventListener('click', function(e) {
        if (touchPreventClick) {
          // Prevent ghost click after touch
          touchPreventClick = false;
          return;
        }
        const now = Date.now();
        const card = img.closest('.fb-card');
        const bar = card.querySelector('.insta-like-bar');
        const btn = bar.querySelector('.insta-like-btn');
        const overlay = card.querySelector('.heart-anim-overlay');
        const floatingContainer = card.querySelector('.floating-heart-container');
        if (now - lastTap < 350) {
          clearTimeout(clickTimer);
          // Like logic
          btn.classList.add('like-bounce');
          setTimeout(()=>btn.classList.remove('like-bounce'), 400);
          btn.classList.add('liked');
          btn.setAttribute('data-liked', 'true');
          btn.querySelector('i').className = 'bi bi-heart-fill';
          overlay.style.display = '';
          overlay.classList.add('show');
          setTimeout(()=>{ overlay.classList.remove('show'); overlay.style.display='none'; }, 700);
          // Floating heart animation
          const floatHeart = document.createElement('span');
          floatHeart.className = 'floating-heart';
          floatHeart.innerHTML = '<i class="bi bi-heart-fill"></i>';
          floatingContainer.appendChild(floatHeart);
          setTimeout(()=>{ floatHeart.remove(); }, 1100);
          // Small heart below image
          const smallHeart = document.createElement('span');
          smallHeart.className = 'small-heart-below';
          smallHeart.innerHTML = '<i class="bi bi-heart-fill"></i>';
          floatingContainer.appendChild(smallHeart);
          setTimeout(()=>{ smallHeart.remove(); }, 1100);
          // Always call the backend to toggle like/unlike
          fetch(`/api/gallery/${card.getAttribute('data-id')}/likes/`, {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({reaction:'like'})
          }).then(r=>r.json()).then(d=>{
            updateLikeBar(bar, card.getAttribute('data-id'));
            showToast(d.liked ? 'You liked this!' : 'Like removed');
          });
        } else {
          clickTimer = setTimeout(() => {
            openModal(card);
          }, 350);
        }
        lastTap = now;
      });
      // Mobile: touch
      img.addEventListener('touchend', function(e) {
        const now = Date.now();
        const card = img.closest('.fb-card');
        const bar = card.querySelector('.insta-like-bar');
        const btn = bar.querySelector('.insta-like-btn');
        const overlay = card.querySelector('.heart-anim-overlay');
        const floatingContainer = card.querySelector('.floating-heart-container');
        if (now - lastTouch < 350) {
          clearTimeout(touchTimer);
          e.preventDefault();
          e.stopPropagation();
          touchPreventClick = true;
          // Like logic
          console.log('Double-tap detected!');
          btn.classList.add('like-bounce');
          setTimeout(()=>btn.classList.remove('like-bounce'), 400);
          btn.classList.add('liked');
          btn.setAttribute('data-liked', 'true');
          btn.querySelector('i').className = 'bi bi-heart-fill';
          overlay.style.display = '';
          overlay.classList.add('show');
          setTimeout(()=>{ overlay.classList.remove('show'); overlay.style.display='none'; }, 700);
          // Floating heart animation
          const floatHeart = document.createElement('span');
          floatHeart.className = 'floating-heart';
          floatHeart.innerHTML = '<i class="bi bi-heart-fill"></i>';
          floatingContainer.appendChild(floatHeart);
          setTimeout(()=>{ floatHeart.remove(); }, 1100);
          // Small heart below image
          const smallHeart = document.createElement('span');
          smallHeart.className = 'small-heart-below';
          smallHeart.innerHTML = '<i class="bi bi-heart-fill"></i>';
          floatingContainer.appendChild(smallHeart);
          setTimeout(()=>{ smallHeart.remove(); }, 1100);
          // Always call the backend to toggle like/unlike
          fetch(`/api/gallery/${card.getAttribute('data-id')}/likes/`, {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({reaction:'like'})
          }).then(r=>r.json()).then(d=>{
            updateLikeBar(bar, card.getAttribute('data-id'));
            showToast(d.liked ? 'You liked this!' : 'Like removed');
          });
        } else {
          touchTimer = setTimeout(() => {
            openModal(card);
          }, 350);
        }
        lastTouch = now;
      });
    });
    // Modal like button
    document.querySelectorAll('.modal-like-btn').forEach(btn => {
        btn.addEventListener('click', function(e) {
            const id = document.getElementById('galleryModal').getAttribute('data-current-id');
            fetch(`/api/gallery/${id}/likes/`, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({reaction:'like'})})
                .then(r=>r.json()).then(d=>{
                    btn.classList.toggle('liked', d.liked);
                    btn.querySelector('i').className = d.liked ? 'bi bi-heart-fill' : 'bi bi-heart';
                    document.getElementById('modalLikeCount').textContent = d.counts.like;
                    showToast(d.liked ? 'You liked this!' : 'Like removed');
                });
        });
    });
    // Comment form: enable/disable send button
    const commentInput = document.getElementById('commentText');
    const sendBtn = document.getElementById('sendCommentBtn');
    commentInput.addEventListener('input', function() {
      sendBtn.disabled = !commentInput.value.trim();
    });
    // Comment form submit
    document.getElementById('commentForm').addEventListener('submit', function(e) {
      e.preventDefault();
      const galleryId = document.getElementById('galleryModal').getAttribute('data-current-id');
      console.log('Comment form submit fired. Gallery ID:', galleryId);
      if (!galleryId) {
        showToast('Gallery ID missing. Please close and reopen the modal.');
        console.error('Gallery ID missing on comment submit!');
        return;
      }
      const comment = commentInput.value.trim();
      if (!comment) return;
      sendBtn.disabled = true;
      sendBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
      fetch(`/api/gallery/${galleryId}/comments/`, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({comment})
      }).then(r=>r.json()).then(d=>{
        sendBtn.disabled = false;
        sendBtn.innerHTML = '<i class="bi bi-send"></i>';
        if (d.success) {
          const list = document.getElementById('commentsList');
          let avatarHtml = '';
          if (d.comment.profile_pic) {
            avatarHtml = `<img src='${d.comment.profile_pic}' class='comment-avatar-img' alt='profile' />`;
          } else {
            avatarHtml = `<span class='avatar comment-avatar-fallback'>${d.comment.name ? d.comment.name[0].toUpperCase() : 'A'}</span>`;
          }
          const div = document.createElement('div');
          div.className = 'comment-card';
          div.innerHTML = `
            <div class='d-flex align-items-center gap-2'>
              ${avatarHtml}
              <div class='flex-grow-1'>
                <div class='fw-semibold small mb-1'>${d.comment.name}</div>
                <div class='comment-text'>${d.comment.comment}</div>
                <div class='text-muted tiny mt-1'>${d.comment.created_at}</div>
              </div>
            </div>
          `;
          list.prepend(div);
          commentInput.value = '';
          sendBtn.disabled = true;
          showToast('Comment posted!');
        }
      }).catch(()=>{
        sendBtn.disabled = false;
        sendBtn.innerHTML = '<i class="bi bi-send"></i>';
        showToast('Failed to post comment.');
      });
    });
    // Comment icon button: open modal and focus comment input
    document.querySelectorAll('.insta-comment-btn').forEach(btn => {
      btn.addEventListener('click', function(e) {
        e.preventDefault();
        const id = btn.getAttribute('data-id');
        const card = document.querySelector(`.fb-card[data-id='${id}']`);
        if (card) {
          openModal(card);
          setTimeout(() => {
            const input = document.getElementById('commentText');
            if (input) input.focus();
          }, 400); // Wait for modal animation
        }
      });
    });
});
</script>
{% endblock %}