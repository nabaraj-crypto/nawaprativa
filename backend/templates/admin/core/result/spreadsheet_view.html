{% extends "admin/base_site.html" %}
{% load static %}

{% block title %}Results Spreadsheet View{% endblock %}

{% block extrastyle %}
{{ block.super }}
<link rel="stylesheet" type="text/css" href="{% static 'admin/css/results_admin.css' %}">
<style>
    .spreadsheet-container {
        padding: 20px;
        background: #f8f9fa;
        min-height: 100vh;
        overflow-x: auto;
        max-width: 100%;
    }
    
    .spreadsheet-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 30px;
        text-align: center;
        border-radius: 10px;
        margin-bottom: 30px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    
    .spreadsheet-header h1 {
        margin: 0;
        font-size: 32px;
        font-weight: 700;
    }
    
    .spreadsheet-header p {
        margin: 10px 0 0 0;
        font-size: 16px;
        opacity: 0.9;
    }
    
    .controls-bar {
        background: white;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        display: flex;
        gap: 20px;
        align-items: center;
        flex-wrap: wrap;
        overflow-x: auto;
    }
    
    .filter-group {
        display: flex;
        align-items: center;
        gap: 10px;
        min-width: 0;
        flex-shrink: 0;
        margin-right: 15px;
    }
    
    .filter-group label {
        font-weight: 600;
        color: #495057;
        white-space: nowrap;
    }
    
    .filter-group select {
        padding: 8px 12px;
        border: 1px solid #ced4da;
        border-radius: 6px;
        background: white;
        font-size: 14px;
        min-width: 200px;
        max-width: none;
        width: auto;
        text-overflow: clip;
        overflow: visible;
        white-space: nowrap;
        box-sizing: border-box;
        resize: horizontal;
    }
    
    .filter-group select option {
        padding: 8px 12px;
        white-space: nowrap;
        overflow: visible;
        text-overflow: clip;
        min-width: 180px;
        width: auto;
    }
    
    /* Ensure dropdown text is never cut off */
    .filter-group select:focus {
        min-width: 200px;
        max-width: none;
        overflow: visible;
        text-overflow: clip;
    }
    
    .filter-group select:hover {
        min-width: 200px;
        max-width: none;
        overflow: visible;
        text-overflow: clip;
    }
    
    /* Force full text visibility */
    .filter-group select,
    .filter-group select option {
        text-overflow: clip !important;
        overflow: visible !important;
        white-space: nowrap !important;
    }
    
    .btn-action {
        padding: 10px 20px;
        border: none;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer !important;
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        white-space: nowrap;
        position: relative;
        z-index: 1000;
        pointer-events: auto !important;
        user-select: none;
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
    }
    
    .btn-action:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    
    .btn-action:active {
        transform: translateY(0);
    }
    
    .btn-primary { background: #2196f3; color: white; }
    .btn-primary:hover { background: #1976d2; transform: translateY(-2px); }
    
    .btn-success { background: #4caf50; color: white; }
    .btn-success:hover { background: #388e3c; transform: translateY(-2px); }
    
    .btn-warning { background: #ff9800; color: white; }
    .btn-warning:hover { background: #f57c00; transform: translateY(-2px); }
    
    .btn-danger { background: #f44336; color: white; }
    .btn-danger:hover { background: #d32f2f; transform: translateY(-2px); }
    
    .btn-info { background: #00bcd4; color: white; }
    .btn-info:hover { background: #0097a7; transform: translateY(-2px); }
    
    .spreadsheet-wrapper {
        background: white;
        border-radius: 10px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        overflow-x: auto;
        overflow-y: hidden;
    }
    
    .spreadsheet-table {
        width: 100%;
        min-width: 1200px;
        border-collapse: collapse;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        table-layout: fixed;
    }
    
    /* Column width specifications */
    .spreadsheet-table th:nth-child(1), .spreadsheet-table td:nth-child(1) { width: 15%; } /* Student Name */
    .spreadsheet-table th:nth-child(2), .spreadsheet-table td:nth-child(2) { width: 8%; }  /* Nepali */
    .spreadsheet-table th:nth-child(3), .spreadsheet-table td:nth-child(3) { width: 8%; }  /* Math */
    .spreadsheet-table th:nth-child(4), .spreadsheet-table td:nth-child(4) { width: 8%; }  /* Science */
    .spreadsheet-table th:nth-child(5), .spreadsheet-table td:nth-child(5) { width: 8%; }  /* Computer */
    .spreadsheet-table th:nth-child(6), .spreadsheet-table td:nth-child(6) { width: 8%; }  /* Social */
    .spreadsheet-table th:nth-child(7), .spreadsheet-table td:nth-child(7) { width: 8%; }  /* Total */
    .spreadsheet-table th:nth-child(8), .spreadsheet-table td:nth-child(8) { width: 8%; }  /* Percentage */
    .spreadsheet-table th:nth-child(9), .spreadsheet-table td:nth-child(9) { width: 8%; }  /* Grade */
    .spreadsheet-table th:nth-child(10), .spreadsheet-table td:nth-child(10) { width: 8%; } /* GPA */
    .spreadsheet-table th:nth-child(11), .spreadsheet-table td:nth-child(11) { width: 8%; } /* Remarks */
    .spreadsheet-table th:nth-child(12), .spreadsheet-table td:nth-child(12) { width: 11%; } /* Actions */
    
    .spreadsheet-table th {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        padding: 15px 10px;
        font-weight: 700;
        text-align: center;
        font-size: 14px;
        color: #495057;
        position: sticky;
        top: 0;
        z-index: 10;
        white-space: nowrap;
    }
    
    .spreadsheet-table td {
        border: 1px solid #dee2e6;
        padding: 12px 8px;
        text-align: center;
        font-size: 13px;
        vertical-align: middle;
        transition: background-color 0.2s ease;
    }
    
    .spreadsheet-table tr:nth-child(even) {
        background-color: #f8f9fa;
    }
    
    .spreadsheet-table tr:hover {
        background-color: #e3f2fd;
    }
    
    .student-name {
        text-align: left;
        font-weight: 600;
        color: #37474f;
        background: #fafafa;
        min-width: 150px;
    }
    
    .subject-input {
        width: 60px;
        border: none;
        background: transparent;
        text-align: center;
        font-size: 13px;
        padding: 4px;
        border-radius: 3px;
        transition: all 0.2s ease;
    }
    
    .subject-input:focus {
        background: #fff;
        outline: 2px solid #2196f3;
        box-shadow: 0 0 8px rgba(33, 150, 243, 0.3);
    }
    
    .total-cell {
        background: #fff3e0;
        font-weight: 700;
        color: #f57c00;
        font-size: 14px;
    }
    
    .percentage-cell {
        background: #e3f2fd;
        font-weight: 700;
        color: #1976d2;
        font-size: 14px;
    }
    
    .grade-cell {
        font-weight: 700;
        font-size: 14px;
        border-radius: 4px;
        padding: 4px 8px;
    }
    
    .grade-a-plus { background: #4caf50; color: white; }
    .grade-a { background: #8bc34a; color: white; }
    .grade-b-plus { background: #cddc39; color: #333; }
    .grade-b { background: #ffeb3b; color: #333; }
    .grade-c-plus { background: #ff9800; color: white; }
    .grade-c { background: #ff5722; color: white; }
    .grade-d { background: #f44336; color: white; }
    .grade-e { background: #9c27b0; color: white; }
    
    .gpa-cell {
        background: #f3e5f5;
        font-weight: 700;
        color: #7b1fa2;
        font-size: 14px;
    }
    
    .remarks-cell {
        background: #fce4ec;
        font-weight: 600;
        color: #c2185b;
        font-size: 12px;
        max-width: 120px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    
    .actions-cell {
        background: #f8f9fa;
        min-width: 120px;
        white-space: nowrap;
    }
    
    .btn-small {
        padding: 4px 8px;
        font-size: 11px;
        margin: 2px;
    }
    
    .grading-scale {
        background: white;
        border-radius: 10px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        margin-top: 30px;
        overflow: hidden;
    }
    
    .grading-scale h3 {
        background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
        color: white;
        margin: 0;
        padding: 20px;
        font-size: 20px;
        text-align: center;
    }
    
    .grading-scale-table {
        width: 100%;
        border-collapse: collapse;
    }
    
    .grading-scale-table th,
    .grading-scale-table td {
        border: 1px solid #dee2e6;
        padding: 12px;
        text-align: center;
        font-size: 14px;
    }
    
    .grading-scale-table th {
        background: #f8f9fa;
        font-weight: 700;
        color: #495057;
    }
    
    .grading-scale-table tr:nth-child(even) {
        background-color: #f8f9fa;
    }
    
    .status-bar {
        background: white;
        padding: 15px 20px;
        border-radius: 8px;
        margin-top: 20px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .status-info {
        display: flex;
        gap: 20px;
        align-items: center;
    }
    
    .status-item {
        display: flex;
        align-items: center;
        gap: 5px;
        font-weight: 600;
    }
    
    .status-value {
        background: #e3f2fd;
        color: #1976d2;
        padding: 4px 8px;
        border-radius: 4px;
        font-weight: 700;
    }
    
    @media (max-width: 768px) {
        .controls-bar {
            flex-direction: column;
            align-items: stretch;
        }
        
        .filter-group {
            justify-content: space-between;
        }
        
        .spreadsheet-table {
            font-size: 11px;
        }
        
        .spreadsheet-table th,
        .spreadsheet-table td {
            padding: 8px 4px;
        }
        
        .subject-input {
            width: 50px;
            font-size: 11px;
        }
    }
</style>
{% endblock %}

{% block content %}
{% csrf_token %}
<div class="spreadsheet-container">
    <div class="spreadsheet-header">
        <h1>📊 Results Management - Spreadsheet View</h1>
        <p>Manage student results with dynamic calculations and real-time updates</p>
    </div>
    
    <div class="controls-bar">
        <div class="filter-group">
            <label for="class-filter">Class:</label>
            <select id="class-filter">
                <option value="">All Classes</option>
                <option value="10">Class 10</option>
                <option value="9">Class 9</option>
                <option value="8">Class 8</option>
                <option value="7">Class 7</option>
                <option value="6">Class 6</option>
            </select>
        </div>
        
        <div class="filter-group">
            <label for="exam-filter">Exam:</label>
            <select id="exam-filter">
                <option value="">All Exams</option>
                <option value="Final Term">Final Term</option>
                <option value="Mid Term">Mid Term</option>
                <option value="Unit Test">Unit Test</option>
                <option value="Pre-Board">Pre-Board</option>
                <option value="Board Exam">Board Exam</option>
            </select>
        </div>
        
        <div class="filter-group">
            <label for="year-filter">Year:</label>
            <select id="year-filter">
                <option value="">All Years</option>
                <option value="2024-25">2024-25</option>
                <option value="2023-24">2023-24</option>
                <option value="2022-23">2022-23</option>
            </select>
        </div>
        
        <button class="btn-action btn-primary" id="add-row-btn">
            ➕ Add Row
        </button>
        
        <button class="btn-action btn-success" id="save-all-btn" onclick="console.log('Save All clicked via onclick'); if(typeof saveAllResults === 'function') { saveAllResults(); } else { alert('Function not loaded yet!'); }">
            💾 Save All
        </button>
        
        <button class="btn-action btn-warning" id="generate-analytics-btn">
            📈 Analytics
        </button>
        
        <button class="btn-action btn-info" id="export-excel-btn">
            📊 Export Excel
        </button>
        
        <button class="btn-action btn-success" id="import-excel-btn">
            📥 Import Excel
        </button>
        
        <button class="btn-action btn-info" id="download-template-btn">
            📋 Download Template
        </button>
        
        <button class="btn-action btn-danger" id="clear-all-btn" onclick="console.log('Clear All clicked via onclick'); if(typeof clearAllData === 'function') { clearAllData(); } else { alert('Function not loaded yet!'); }">
            🗑️ Clear All
        </button>
        
        <button class="btn-action btn-warning" id="print-results-btn" onclick="console.log('Print Results clicked via onclick'); if(typeof printResults === 'function') { printResults(); } else { alert('Function not loaded yet!'); }">
            🖨️ Print Results
        </button>
        
        <button class="btn-action btn-info" onclick="if(typeof testFunction === 'function') { testFunction(); } else { alert('Global function not available!'); }">
            🧪 Test Global Function
        </button>
    </div>
    
    <div class="spreadsheet-wrapper">
        <table class="spreadsheet-table">
            <thead>
                <tr>
                    <th rowspan="2">Student Name</th>
                    <th colspan="5" style="text-align: center; background: #e8f5e8;">Subject Marks</th>
                    <th rowspan="2">Total</th>
                    <th rowspan="2">Percentage</th>
                    <th rowspan="2">Grade</th>
                    <th rowspan="2">GPA</th>
                    <th rowspan="2">Remarks</th>
                    <th rowspan="2">Actions</th>
                </tr>
                <tr>
                    <th style="background: #e8f5e8;">Nepali</th>
                    <th style="background: #e8f5e8;">Math</th>
                    <th style="background: #e8f5e8;">Science</th>
                    <th style="background: #e8f5e8;">Computer</th>
                    <th style="background: #e8f5e8;">Social</th>
                </tr>
            </thead>
            <tbody id="results-tbody">
                {% for result in results %}
                <tr class="result-row" data-result-id="{{ result.id }}">
                    <td class="student-name">
                        <input type="text" class="subject-input" value="{{ result.student_name }}" placeholder="Student Name">
                    </td>
                    <td><input type="number" class="subject-input" value="0" min="0" max="100" data-subject="nepali"></td>
                    <td><input type="number" class="subject-input" value="0" min="0" max="100" data-subject="math"></td>
                    <td><input type="number" class="subject-input" value="0" min="0" max="100" data-subject="science"></td>
                    <td><input type="number" class="subject-input" value="0" min="0" max="100" data-subject="computer"></td>
                    <td><input type="number" class="subject-input" value="0" min="0" max="100" data-subject="social"></td>
                    <td class="total-cell" data-total="0">0</td>
                    <td class="percentage-cell" data-percentage="0">0.00%</td>
                    <td class="grade-cell" data-grade="-">-</td>
                    <td class="gpa-cell" data-gpa="0">0.00</td>
                    <td class="remarks-cell" data-remarks="-">-</td>
                    <td class="actions-cell">
                        <button class="btn-action btn-primary btn-small" onclick="editRow(this)">Edit</button>
                        <button class="btn-action btn-danger btn-small" onclick="deleteRow(this)">Del</button>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="12" style="text-align: center; padding: 60px; color: #6c757d;">
                        <h3>No results found</h3>
                        <p>Click "Add Row" to start adding student results</p>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    <div class="status-bar">
        <div class="status-info">
            <div class="status-item">
                <span>Total Students:</span>
                <span class="status-value" id="total-students">0</span>
            </div>
            <div class="status-item">
                <span>Average GPA:</span>
                <span class="status-value" id="average-gpa">0.00</span>
            </div>
            <div class="status-item">
                <span>Pass Rate:</span>
                <span class="status-value" id="pass-rate">0%</span>
            </div>
        </div>
        <div class="status-info">
            <span id="last-saved">Not saved yet</span>
        </div>
    </div>
    
    <div class="grading-scale">
        <h3>📊 Grading Scale Reference</h3>
        <table class="grading-scale-table">
            <thead>
                <tr>
                    <th>S.N.</th>
                    <th>Percentage</th>
                    <th>Grade</th>
                    <th>Remarks</th>
                    <th>GPA</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>1</td>
                    <td>90-100%</td>
                    <td class="grade-a-plus">A+</td>
                    <td>Outstanding</td>
                    <td>4.0</td>
                </tr>
                <tr>
                    <td>2</td>
                    <td>80-90%</td>
                    <td class="grade-a">A</td>
                    <td>Excellent</td>
                    <td>3.6</td>
                </tr>
                <tr>
                    <td>3</td>
                    <td>70-80%</td>
                    <td class="grade-b-plus">B+</td>
                    <td>Very Good</td>
                    <td>3.2</td>
                </tr>
                <tr>
                    <td>4</td>
                    <td>60-70%</td>
                    <td class="grade-b">B</td>
                    <td>Good</td>
                    <td>2.8</td>
                </tr>
                <tr>
                    <td>5</td>
                    <td>50-60%</td>
                    <td class="grade-c-plus">C+</td>
                    <td>Above Average</td>
                    <td>2.4</td>
                </tr>
                <tr>
                    <td>6</td>
                    <td>40-50%</td>
                    <td class="grade-c">C</td>
                    <td>Average</td>
                    <td>2.0</td>
                </tr>
                <tr>
                    <td>7</td>
                    <td>20-40%</td>
                    <td class="grade-d">D</td>
                    <td>Below Average</td>
                    <td>1.6</td>
                </tr>
                <tr>
                    <td>8</td>
                    <td>1-20%</td>
                    <td class="grade-e">E</td>
                    <td>Insufficient</td>
                    <td>0.8</td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<script>
// Global function availability check
window.testFunction = function() {
    alert('Global function test works!');
    console.log('Global function test successful');
};

// Define all button functions immediately
window.clearAllData = function() {
    console.log('Clear All button clicked!'); // Debug log
    alert('Clear All button is working!'); // Test alert
    
    // Simple test - just clear the first input field
    const firstInput = document.querySelector('input[type="text"]');
    if (firstInput) {
        firstInput.value = 'CLEARED!';
        console.log('First input cleared to:', firstInput.value);
    }
    
    if (confirm('Are you sure you want to clear all data? This action cannot be undone.')) {
        console.log('User confirmed clear action'); // Debug log
        
        // Clear all input fields
        const inputs = document.querySelectorAll('.subject-input');
        console.log('Found', inputs.length, 'subject inputs'); // Debug log
        inputs.forEach(input => {
            input.value = '';
        });
        
        // Clear student names
        const nameInputs = document.querySelectorAll('input[type="text"]');
        console.log('Found', nameInputs.length, 'name inputs'); // Debug log
        nameInputs.forEach(input => {
            input.value = '';
        });
        
        // Reset calculated cells
        const calculatedCells = document.querySelectorAll('.total-cell, .percentage-cell, .grade-cell, .gpa-cell, .remarks-cell');
        console.log('Found', calculatedCells.length, 'calculated cells'); // Debug log
        calculatedCells.forEach(cell => {
            cell.textContent = '0';
            cell.setAttribute('data-total', '0');
            cell.setAttribute('data-percentage', '0');
            cell.setAttribute('data-grade', '-');
            cell.setAttribute('data-gpa', '0');
            cell.setAttribute('data-remarks', '-');
        });
        
        // Remove grade styling
        const gradeCells = document.querySelectorAll('.grade-cell');
        gradeCells.forEach(cell => {
            cell.className = 'grade-cell';
        });
        
        updateStatusBar();
        showNotification('All data has been cleared successfully!', 'success');
        console.log('Clear operation completed'); // Debug log
    }
};

window.printResults = function() {
    console.log('Print Results button clicked!'); // Debug log
    alert('Print Results button is working!'); // Test alert
    
    const rows = document.querySelectorAll('.result-row');
    let printContent = `
        <html>
        <head>
            <title>Results Report</title>
            <style>
                body { font-family: Arial, sans-serif; margin: 20px; }
                table { border-collapse: collapse; width: 100%; margin-top: 20px; }
                th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                th { background-color: #f2f2f2; }
                .header { text-align: center; margin-bottom: 20px; }
                .grade-a { color: #4caf50; font-weight: bold; }
                .grade-b { color: #2196f3; font-weight: bold; }
                .grade-c { color: #ff9800; font-weight: bold; }
                .grade-d { color: #f44336; font-weight: bold; }
                .grade-e { color: #9c27b0; font-weight: bold; }
            </style>
        </head>
        <body>
            <div class="header">
                <h1>Student Results Report</h1>
                <p>Class: ${document.getElementById('class-filter')?.value || '10'}</p>
                <p>Exam: ${document.getElementById('exam-filter')?.value || 'Final Term'}</p>
                <p>Academic Year: ${document.getElementById('year-filter')?.value || '2024-25'}</p>
                <p>Generated on: ${new Date().toLocaleDateString()}</p>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>Student Name</th>
                        <th>Nepali</th>
                        <th>Math</th>
                        <th>Science</th>
                        <th>Computer</th>
                        <th>Social</th>
                        <th>Total</th>
                        <th>Percentage</th>
                        <th>Grade</th>
                        <th>GPA</th>
                        <th>Remarks</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    rows.forEach(row => {
        const studentName = row.querySelector('input[type="text"]')?.value || 'N/A';
        const inputs = row.querySelectorAll('input[type="number"]');
        const nepali = inputs[0]?.value || '0';
        const math = inputs[1]?.value || '0';
        const science = inputs[2]?.value || '0';
        const computer = inputs[3]?.value || '0';
        const social = inputs[4]?.value || '0';
        const total = row.querySelector('.total-cell')?.textContent || '0';
        const percentage = row.querySelector('.percentage-cell')?.textContent || '0';
        const grade = row.querySelector('.grade-cell')?.textContent || '-';
        const gpa = row.querySelector('.gpa-cell')?.textContent || '0';
        const remarks = row.querySelector('.remarks-cell')?.textContent || '-';
        
        printContent += `
            <tr>
                <td>${studentName}</td>
                <td>${nepali}</td>
                <td>${math}</td>
                <td>${science}</td>
                <td>${computer}</td>
                <td>${social}</td>
                <td>${total}</td>
                <td>${percentage}%</td>
                <td class="grade-${grade.toLowerCase()}">${grade}</td>
                <td>${gpa}</td>
                <td>${remarks}</td>
            </tr>
        `;
    });
    
    printContent += `
                </tbody>
            </table>
        </body>
        </html>
    `;
    
    const printWindow = window.open('', '_blank');
    printWindow.document.write(printContent);
    printWindow.document.close();
    printWindow.print();
};

window.saveAllResults = function() {
    console.log('Save All button clicked!'); // Debug log
    alert('Save All button is working!'); // Test alert
    const rows = document.querySelectorAll('.result-row');
    console.log('Found', rows.length, 'result rows'); // Debug log
    const data = [];
    
    rows.forEach((row, index) => {
        const studentName = row.querySelector('input[type="text"]').value;
        if (!studentName.trim()) {
            showNotification(`Row ${index + 1}: Student name is required!`, 'error');
            return;
        }
        
        const subjectInputs = row.querySelectorAll('input[type="number"]');
        const nepali = parseFloat(subjectInputs[0]?.value) || 0;
        const math = parseFloat(subjectInputs[1]?.value) || 0;
        const science = parseFloat(subjectInputs[2]?.value) || 0;
        const computer = parseFloat(subjectInputs[3]?.value) || 0;
        const social = parseFloat(subjectInputs[4]?.value) || 0;
        
        const total = parseFloat(row.querySelector('.total-cell').getAttribute('data-total')) || 0;
        const percentage = parseFloat(row.querySelector('.percentage-cell').getAttribute('data-percentage')) || 0;
        const gpa = parseFloat(row.querySelector('.gpa-cell').getAttribute('data-gpa')) || 0;
        
        const rowData = {
            student_name: studentName,
            roll_number: `R${(index + 1).toString().padStart(3, '0')}`,
            student_class: document.getElementById('class-filter')?.value || '10',
            exam_type: document.getElementById('exam-filter')?.value || 'Final Term',
            academic_year: document.getElementById('year-filter')?.value || '2024-25',
            total: total,
            gpa: gpa,
            percentage: percentage,
            total_subjects: 5,
            passed_subjects: [nepali, math, science, computer, social].filter(mark => mark >= 40).length,
            failed_subjects: [nepali, math, science, computer, social].filter(mark => mark < 40).length,
            class_position: index + 1,
            total_students: rows.length,
            is_published: false
        };
        
        data.push(rowData);
    });
    
    if (data.length === 0) {
        showNotification('No valid data to save!', 'error');
        return;
    }
    
    // Show loading
    showNotification('Saving results to database...', 'info');
    
    // Send to server
    fetch('/api/results/bulk-save/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({ results: data })
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            document.getElementById('last-saved').textContent = 'Last saved: ' + new Date().toLocaleTimeString();
            showNotification(result.message, 'success');
        } else {
            showNotification('Save failed: ' + result.error, 'error');
        }
    })
    .catch(error => {
        showNotification('Save failed: ' + error.message, 'error');
    });
};

// Test function availability immediately
console.log('Script loading - testing function availability...');
console.log('testFunction available:', typeof window.testFunction === 'function');
console.log('clearAllData available:', typeof window.clearAllData === 'function');
console.log('printResults available:', typeof window.printResults === 'function');
console.log('saveAllResults available:', typeof window.saveAllResults === 'function');

document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM Content Loaded - Initializing spreadsheet...'); // Debug log
    initializeSpreadsheet();
    
    // Add event listeners
    console.log('Adding event listeners...'); // Debug log
    
    const addRowBtn = document.getElementById('add-row-btn');
    const saveAllBtn = document.getElementById('save-all-btn');
    const generateAnalyticsBtn = document.getElementById('generate-analytics-btn');
    const exportExcelBtn = document.getElementById('export-excel-btn');
    const importExcelBtn = document.getElementById('import-excel-btn');
    const downloadTemplateBtn = document.getElementById('download-template-btn');
    const clearAllBtn = document.getElementById('clear-all-btn');
    const printResultsBtn = document.getElementById('print-results-btn');
    
    console.log('Button elements found:', {
        addRowBtn: !!addRowBtn,
        saveAllBtn: !!saveAllBtn,
        generateAnalyticsBtn: !!generateAnalyticsBtn,
        exportExcelBtn: !!exportExcelBtn,
        importExcelBtn: !!importExcelBtn,
        downloadTemplateBtn: !!downloadTemplateBtn,
        clearAllBtn: !!clearAllBtn,
        printResultsBtn: !!printResultsBtn
    }); // Debug log
    
    if (addRowBtn) addRowBtn.addEventListener('click', addNewRow);
    if (saveAllBtn) saveAllBtn.addEventListener('click', saveAllResults);
    if (generateAnalyticsBtn) generateAnalyticsBtn.addEventListener('click', generateAnalytics);
    if (exportExcelBtn) exportExcelBtn.addEventListener('click', exportToExcel);
    if (importExcelBtn) importExcelBtn.addEventListener('click', importFromExcel);
    if (downloadTemplateBtn) downloadTemplateBtn.addEventListener('click', downloadTemplate);
    if (clearAllBtn) {
        clearAllBtn.addEventListener('click', function(e) {
            console.log('Clear All button clicked! Event:', e); // Debug log
            clearAllData();
        });
        console.log('Clear All button event listener added'); // Debug log
    }
    if (printResultsBtn) {
        printResultsBtn.addEventListener('click', printResults);
        console.log('Print Results button event listener added'); // Debug log
    }
    
    console.log('Event listeners added successfully!'); // Debug log
    
    // Test button visibility
    setTimeout(() => {
        console.log('Testing button visibility...'); // Debug log
        const clearBtn = document.getElementById('clear-all-btn');
        const printBtn = document.getElementById('print-results-btn');
        const saveBtn = document.getElementById('save-all-btn');
        
        if (clearBtn) {
            console.log('Clear button is visible:', clearBtn.offsetWidth > 0 && clearBtn.offsetHeight > 0);
            console.log('Clear button position:', clearBtn.getBoundingClientRect());
        }
        if (printBtn) {
            console.log('Print button is visible:', printBtn.offsetWidth > 0 && printBtn.offsetHeight > 0);
            console.log('Print button position:', printBtn.getBoundingClientRect());
        }
        if (saveBtn) {
            console.log('Save button is visible:', saveBtn.offsetWidth > 0 && saveBtn.offsetHeight > 0);
            console.log('Save button position:', saveBtn.getBoundingClientRect());
        }
    }, 1000);
    
    // Filter event listeners
    document.getElementById('class-filter').addEventListener('change', filterResults);
    document.getElementById('exam-filter').addEventListener('change', filterResults);
    document.getElementById('year-filter').addEventListener('change', filterResults);
});

function initializeSpreadsheet() {
    const rows = document.querySelectorAll('.result-row');
    rows.forEach(row => {
        initializeRow(row);
    });
    updateStatusBar();
}

function initializeRow(row) {
    const inputs = row.querySelectorAll('input[type="number"]');
    inputs.forEach(input => {
        input.addEventListener('input', () => calculateRowTotals(row));
    });
    
    const nameInput = row.querySelector('input[type="text"]');
    if (nameInput) {
        nameInput.addEventListener('input', () => updateStatusBar());
    }
}

function calculateRowTotals(row) {
    const subjectInputs = row.querySelectorAll('input[type="number"]');
    let total = 0;
    let validMarks = 0;
    
    subjectInputs.forEach(input => {
        const value = parseFloat(input.value) || 0;
        if (value > 0) {
            total += value;
            validMarks++;
        }
    });
    
    // Update total
    const totalCell = row.querySelector('.total-cell');
    if (totalCell) {
        totalCell.textContent = total;
        totalCell.setAttribute('data-total', total);
    }
    
    // Calculate percentage
    const maxTotal = validMarks * 100;
    const percentage = maxTotal > 0 ? (total / maxTotal * 100) : 0;
    
    const percentageCell = row.querySelector('.percentage-cell');
    if (percentageCell) {
        percentageCell.textContent = percentage.toFixed(2) + '%';
        percentageCell.setAttribute('data-percentage', percentage.toFixed(2));
    }
    
    // Calculate GPA and grade
    const gpa = calculateGPA(percentage);
    const grade = getGradeFromPercentage(percentage);
    const remarks = getRemarksFromGrade(grade);
    
    const gpaCell = row.querySelector('.gpa-cell');
    if (gpaCell) {
        gpaCell.textContent = gpa.toFixed(2);
        gpaCell.setAttribute('data-gpa', gpa.toFixed(2));
    }
    
    const gradeCell = row.querySelector('.grade-cell');
    if (gradeCell) {
        gradeCell.textContent = grade;
        gradeCell.setAttribute('data-grade', grade);
        gradeCell.className = 'grade-cell grade-' + grade.toLowerCase().replace('+', '-plus');
    }
    
    const remarksCell = row.querySelector('.remarks-cell');
    if (remarksCell) {
        remarksCell.textContent = remarks;
        remarksCell.setAttribute('data-remarks', remarks);
    }
    
    updateStatusBar();
}

function calculateGPA(percentage) {
    if (percentage >= 90) return 4.0;
    if (percentage >= 80) return 3.6;
    if (percentage >= 70) return 3.2;
    if (percentage >= 60) return 2.8;
    if (percentage >= 50) return 2.4;
    if (percentage >= 40) return 2.0;
    if (percentage >= 20) return 1.6;
    return 0.8;
}

function getGradeFromPercentage(percentage) {
    if (percentage >= 90) return 'A+';
    if (percentage >= 80) return 'A';
    if (percentage >= 70) return 'B+';
    if (percentage >= 60) return 'B';
    if (percentage >= 50) return 'C+';
    if (percentage >= 40) return 'C';
    if (percentage >= 20) return 'D';
    return 'E';
}

function getRemarksFromGrade(grade) {
    const remarks = {
        'A+': 'Outstanding',
        'A': 'Excellent',
        'B+': 'Very Good',
        'B': 'Good',
        'C+': 'Above Average',
        'C': 'Average',
        'D': 'Below Average',
        'E': 'Insufficient'
    };
    return remarks[grade] || 'N/A';
}

function addNewRow() {
    const tbody = document.getElementById('results-tbody');
    const newRow = document.createElement('tr');
    newRow.className = 'result-row';
    
    newRow.innerHTML = `
        <td class="student-name">
            <input type="text" class="subject-input" placeholder="Student Name">
        </td>
        <td><input type="number" class="subject-input" value="0" min="0" max="100" data-subject="nepali"></td>
        <td><input type="number" class="subject-input" value="0" min="0" max="100" data-subject="math"></td>
        <td><input type="number" class="subject-input" value="0" min="0" max="100" data-subject="science"></td>
        <td><input type="number" class="subject-input" value="0" min="0" max="100" data-subject="computer"></td>
        <td><input type="number" class="subject-input" value="0" min="0" max="100" data-subject="social"></td>
        <td class="total-cell" data-total="0">0</td>
        <td class="percentage-cell" data-percentage="0">0.00%</td>
        <td class="grade-cell" data-grade="-">-</td>
        <td class="gpa-cell" data-gpa="0">0.00</td>
        <td class="remarks-cell" data-remarks="-">-</td>
        <td class="actions-cell">
            <button class="btn-action btn-primary btn-small" onclick="editRow(this)">Edit</button>
            <button class="btn-action btn-danger btn-small" onclick="deleteRow(this)">Del</button>
        </td>
    `;
    
    tbody.appendChild(newRow);
    initializeRow(newRow);
    updateStatusBar();
}

function deleteRow(button) {
    if (confirm('Are you sure you want to delete this row?')) {
        const row = button.closest('tr');
        row.remove();
        updateStatusBar();
    }
}

function editRow(button) {
    const row = button.closest('tr');
    const nameInput = row.querySelector('input[type="text"]');
    nameInput.focus();
}

function filterResults() {
    const classFilter = document.getElementById('class-filter').value;
    const examFilter = document.getElementById('exam-filter').value;
    const yearFilter = document.getElementById('year-filter').value;
    
    const rows = document.querySelectorAll('.result-row');
    rows.forEach(row => {
        let show = true;
        // Add your filtering logic here based on the filters
        row.style.display = show ? '' : 'none';
    });
}

function updateStatusBar() {
    const rows = document.querySelectorAll('.result-row');
    let totalStudents = rows.length;
    let totalGPA = 0;
    let passedStudents = 0;
    
    rows.forEach(row => {
        const gpa = parseFloat(row.querySelector('.gpa-cell').getAttribute('data-gpa')) || 0;
        totalGPA += gpa;
        
        if (gpa >= 2.0) {
            passedStudents++;
        }
    });
    
    const averageGPA = totalStudents > 0 ? totalGPA / totalStudents : 0;
    const passRate = totalStudents > 0 ? (passedStudents / totalStudents) * 100 : 0;
    
    document.getElementById('total-students').textContent = totalStudents;
    document.getElementById('average-gpa').textContent = averageGPA.toFixed(2);
    document.getElementById('pass-rate').textContent = passRate.toFixed(1) + '%';
}

window.saveAllResults = function() {
    console.log('Save All button clicked!'); // Debug log
    alert('Save All button is working!'); // Test alert
    const rows = document.querySelectorAll('.result-row');
    console.log('Found', rows.length, 'result rows'); // Debug log
    const data = [];
    
    rows.forEach((row, index) => {
        const studentName = row.querySelector('input[type="text"]').value;
        if (!studentName.trim()) {
            showNotification(`Row ${index + 1}: Student name is required!`, 'error');
            return;
        }
        
        const subjectInputs = row.querySelectorAll('input[type="number"]');
        const nepali = parseFloat(subjectInputs[0]?.value) || 0;
        const math = parseFloat(subjectInputs[1]?.value) || 0;
        const science = parseFloat(subjectInputs[2]?.value) || 0;
        const computer = parseFloat(subjectInputs[3]?.value) || 0;
        const social = parseFloat(subjectInputs[4]?.value) || 0;
        
        const total = parseFloat(row.querySelector('.total-cell').getAttribute('data-total')) || 0;
        const percentage = parseFloat(row.querySelector('.percentage-cell').getAttribute('data-percentage')) || 0;
        const gpa = parseFloat(row.querySelector('.gpa-cell').getAttribute('data-gpa')) || 0;
        
        const rowData = {
            student_name: studentName,
            roll_number: `R${(index + 1).toString().padStart(3, '0')}`,
            student_class: document.getElementById('class-filter')?.value || '10',
            exam_type: document.getElementById('exam-filter')?.value || 'Final Term',
            academic_year: document.getElementById('year-filter')?.value || '2024-25',
            total: total,
            gpa: gpa,
            percentage: percentage,
            total_subjects: 5,
            passed_subjects: [nepali, math, science, computer, social].filter(mark => mark >= 40).length,
            failed_subjects: [nepali, math, science, computer, social].filter(mark => mark < 40).length,
            class_position: index + 1,
            total_students: rows.length,
            is_published: false
        };
        
        data.push(rowData);
    });
    
    if (data.length === 0) {
        showNotification('No valid data to save!', 'error');
        return;
    }
    
    // Show loading
    showNotification('Saving results to database...', 'info');
    
    // Send to server
    fetch('/api/results/bulk-save/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({ results: data })
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            document.getElementById('last-saved').textContent = 'Last saved: ' + new Date().toLocaleTimeString();
            showNotification(result.message, 'success');
        } else {
            showNotification('Save failed: ' + result.error, 'error');
        }
    })
    .catch(error => {
        showNotification('Save failed: ' + error.message, 'error');
    });
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function generateAnalytics() {
    const rows = document.querySelectorAll('.result-row');
    let totalStudents = rows.length;
    let passedStudents = 0;
    let totalGPA = 0;
    let highestGPA = 0;
    let lowestGPA = 4.0;
    
    rows.forEach(row => {
        const gpa = parseFloat(row.querySelector('.gpa-cell').getAttribute('data-gpa')) || 0;
        totalGPA += gpa;
        
        if (gpa >= 2.0) {
            passedStudents++;
        }
        
        if (gpa > highestGPA) {
            highestGPA = gpa;
        }
        
        if (gpa < lowestGPA && gpa > 0) {
            lowestGPA = gpa;
        }
    });
    
    const averageGPA = totalStudents > 0 ? totalGPA / totalStudents : 0;
    const passPercentage = totalStudents > 0 ? (passedStudents / totalStudents) * 100 : 0;
    
    const analytics = `
        📊 Analytics Report
        
        Total Students: ${totalStudents}
        Passed Students: ${passedStudents}
        Failed Students: ${totalStudents - passedStudents}
        Average GPA: ${averageGPA.toFixed(2)}
        Highest GPA: ${highestGPA.toFixed(2)}
        Lowest GPA: ${lowestGPA.toFixed(2)}
        Pass Percentage: ${passPercentage.toFixed(2)}%
    `;
    
    alert(analytics);
}

function exportToExcel() {
    // Get current filters
    const classFilter = document.getElementById('class-filter')?.value || '';
    const examFilter = document.getElementById('exam-filter')?.value || '';
    const yearFilter = document.getElementById('year-filter')?.value || '';
    
    // Build URL with filters
    let url = '/api/results/export/';
    const params = new URLSearchParams();
    if (classFilter) params.append('class', classFilter);
    if (examFilter) params.append('exam', examFilter);
    if (yearFilter) params.append('year', yearFilter);
    
    if (params.toString()) {
        url += '?' + params.toString();
    }
    
    // Create download link
    const link = document.createElement('a');
    link.href = url;
    link.download = `results_export_${new Date().toISOString().split('T')[0]}.xlsx`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    showNotification('Export started! Check your downloads folder.', 'success');
}

function downloadTemplate() {
    // Create a simple CSV template
    const csvContent = "data:text/csv;charset=utf-8,";
    const headers = "Student Name,Roll Number,Class,Nepali,Math,Science,Computer,Social,Exam Type,Academic Year\n";
    const sampleData = [
        "Hari Gautam,R001,10,85,78,82,90,88,Final Term,2024-25",
        "Ramesh Thapa,R002,10,92,85,88,95,90,Final Term,2024-25",
        "Garima Bhatta,R003,10,78,82,85,88,80,Final Term,2024-25",
        "Sima Rana,R004,10,88,90,92,85,87,Final Term,2024-25",
        "Kiran Shrestha,R005,10,75,80,78,85,82,Final Term,2024-25"
    ];
    
    let fullContent = csvContent + headers + sampleData.join('\n');
    
    // Create download link
    const encodedUri = encodeURI(fullContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", "results_template.csv");
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    showNotification('Template downloaded! Use this to prepare your data for import.', 'success');
}

function importFromExcel() {
    // Create file input
    const fileInput = document.createElement('input');
    fileInput.type = 'file';
    fileInput.accept = '.csv,.xlsx,.xls';
    fileInput.style.display = 'none';
    
    fileInput.addEventListener('change', function(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        // Show loading
        showNotification('Processing file...', 'info');
        
        // Create FormData
        const formData = new FormData();
        formData.append('file', file);
        
        // Send to server
        fetch('/api/results/import/', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Clear existing rows
                const tbody = document.querySelector('#results-tbody');
                const existingRows = tbody.querySelectorAll('.result-row');
                existingRows.forEach(row => row.remove());
                
                // Add imported data
                data.data.forEach(resultData => {
                    addImportedRowFromServer(resultData);
                });
                
                showNotification(data.message, 'success');
                updateStatusBar();
            } else {
                showNotification('Import failed: ' + data.error, 'error');
            }
        })
        .catch(error => {
            showNotification('Import failed: ' + error.message, 'error');
        });
    });
    
    document.body.appendChild(fileInput);
    fileInput.click();
    document.body.removeChild(fileInput);
}

function addImportedRowFromServer(resultData) {
    const tbody = document.querySelector('#results-tbody');
    const newRow = document.createElement('tr');
    newRow.className = 'result-row';
    
    newRow.innerHTML = `
        <td class="student-name">
            <input type="text" class="subject-input" value="${resultData.student_name}" placeholder="Student Name">
        </td>
        <td><input type="number" class="subject-input" value="${resultData.nepali}" min="0" max="100" data-subject="nepali"></td>
        <td><input type="number" class="subject-input" value="${resultData.math}" min="0" max="100" data-subject="math"></td>
        <td><input type="number" class="subject-input" value="${resultData.science}" min="0" max="100" data-subject="science"></td>
        <td><input type="number" class="subject-input" value="${resultData.computer}" min="0" max="100" data-subject="computer"></td>
        <td><input type="number" class="subject-input" value="${resultData.social}" min="0" max="100" data-subject="social"></td>
        <td class="total-cell" data-total="${resultData.total}">${resultData.total}</td>
        <td class="percentage-cell" data-percentage="${resultData.percentage}">${resultData.percentage.toFixed(2)}%</td>
        <td class="grade-cell" data-grade="${getGradeFromPercentage(resultData.percentage)}">${getGradeFromPercentage(resultData.percentage)}</td>
        <td class="gpa-cell" data-gpa="${resultData.gpa}">${resultData.gpa.toFixed(2)}</td>
        <td class="remarks-cell" data-remarks="${getRemarksFromGrade(getGradeFromPercentage(resultData.percentage))}">${getRemarksFromGrade(getGradeFromPercentage(resultData.percentage))}</td>
        <td class="actions-cell">
            <button class="btn-action btn-primary btn-small" onclick="editRow(this)">Edit</button>
            <button class="btn-action btn-danger btn-small" onclick="deleteRow(this)">Del</button>
        </td>
    `;
    
    tbody.appendChild(newRow);
    initializeRow(newRow);
}

// Notification system
function showNotification(message, type = 'info') {
    // Remove existing notifications
    const existingNotifications = document.querySelectorAll('.notification');
    existingNotifications.forEach(notification => notification.remove());
    
    // Create notification element
    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    notification.innerHTML = `
        <div class="notification-content">
            <span class="notification-message">${message}</span>
            <button class="notification-close" onclick="this.parentElement.parentElement.remove()">×</button>
        </div>
    `;
    
    // Add styles
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: ${type === 'success' ? '#4caf50' : type === 'error' ? '#f44336' : '#2196f3'};
        color: white;
        padding: 15px 20px;
        border-radius: 8px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        z-index: 10000;
        max-width: 400px;
        animation: slideIn 0.3s ease;
    `;
    
    // Add animation styles
    const style = document.createElement('style');
    style.textContent = `
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .notification-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .notification-close {
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            margin-left: 10px;
        }
    `;
    document.head.appendChild(style);
    
    document.body.appendChild(notification);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        if (notification.parentElement) {
            notification.remove();
        }
    }, 5000);
}

// Functions are now defined at the top of the script

window.printResults = function() {
    console.log('Print Results button clicked!'); // Debug log
    alert('Print Results button is working!'); // Test alert
    // Create a print-friendly version
    const printWindow = window.open('', '_blank');
    const rows = document.querySelectorAll('.result-row');
    console.log('Found', rows.length, 'rows to print'); // Debug log
    
    if (rows.length === 0) {
        showNotification('No data to print!', 'error');
        return;
    }
    
    let printContent = `
        <!DOCTYPE html>
        <html>
        <head>
            <title>Student Results Report</title>
            <style>
                body { font-family: Arial, sans-serif; margin: 20px; }
                .header { text-align: center; margin-bottom: 30px; }
                .header h1 { color: #333; margin-bottom: 10px; }
                .header p { color: #666; }
                table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                th, td { border: 1px solid #ddd; padding: 12px; text-align: center; }
                th { background-color: #f8f9fa; font-weight: bold; }
                .student-name { text-align: left; font-weight: bold; }
                .total { background-color: #fff3e0; font-weight: bold; }
                .percentage { background-color: #e3f2fd; font-weight: bold; }
                .grade { font-weight: bold; }
                .grade-a-plus { background-color: #4caf50; color: white; }
                .grade-a { background-color: #8bc34a; color: white; }
                .grade-b-plus { background-color: #cddc39; color: #333; }
                .grade-b { background-color: #ffeb3b; color: #333; }
                .grade-c-plus { background-color: #ff9800; color: white; }
                .grade-c { background-color: #ff5722; color: white; }
                .grade-d { background-color: #f44336; color: white; }
                .grade-e { background-color: #9c27b0; color: white; }
                .gpa { background-color: #f3e5f5; font-weight: bold; }
                .remarks { background-color: #fce4ec; font-weight: bold; }
                .footer { margin-top: 30px; text-align: center; font-size: 12px; color: #666; }
                @media print {
                    body { margin: 0; }
                    .no-print { display: none; }
                }
            </style>
        </head>
        <body>
            <div class="header">
                <h1>📊 Student Results Report</h1>
                <p>Generated on: ${new Date().toLocaleDateString()} at ${new Date().toLocaleTimeString()}</p>
                <p>Total Students: ${rows.length}</p>
            </div>
            
            <table>
                <thead>
                    <tr>
                        <th rowspan="2">Student Name</th>
                        <th colspan="5">Subject Marks</th>
                        <th rowspan="2">Total</th>
                        <th rowspan="2">Percentage</th>
                        <th rowspan="2">Grade</th>
                        <th rowspan="2">GPA</th>
                        <th rowspan="2">Remarks</th>
                    </tr>
                    <tr>
                        <th>Nepali</th>
                        <th>Math</th>
                        <th>Science</th>
                        <th>Computer</th>
                        <th>Social</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    rows.forEach((row, index) => {
        const studentName = row.querySelector('input[type="text"]')?.value || `Student ${index + 1}`;
        const subjectInputs = row.querySelectorAll('input[type="number"]');
        const nepali = subjectInputs[0]?.value || '0';
        const math = subjectInputs[1]?.value || '0';
        const science = subjectInputs[2]?.value || '0';
        const computer = subjectInputs[3]?.value || '0';
        const social = subjectInputs[4]?.value || '0';
        
        const total = row.querySelector('.total-cell')?.textContent || '0';
        const percentage = row.querySelector('.percentage-cell')?.textContent || '0.00%';
        const grade = row.querySelector('.grade-cell')?.textContent || '-';
        const gpa = row.querySelector('.gpa-cell')?.textContent || '0.00';
        const remarks = row.querySelector('.remarks-cell')?.textContent || '-';
        
        const gradeClass = grade !== '-' ? `grade-${grade.toLowerCase().replace('+', '-plus')}` : '';
        
        printContent += `
            <tr>
                <td class="student-name">${studentName}</td>
                <td>${nepali}</td>
                <td>${math}</td>
                <td>${science}</td>
                <td>${computer}</td>
                <td>${social}</td>
                <td class="total">${total}</td>
                <td class="percentage">${percentage}</td>
                <td class="grade ${gradeClass}">${grade}</td>
                <td class="gpa">${gpa}</td>
                <td class="remarks">${remarks}</td>
            </tr>
        `;
    });
    
    printContent += `
                </tbody>
            </table>
            
            <div class="footer">
                <p>This report was generated from the School Management System</p>
                <p>For any queries, please contact the administration</p>
            </div>
        </body>
        </html>
    `;
    
    printWindow.document.write(printContent);
    printWindow.document.close();
    
    // Wait for content to load then print
    printWindow.onload = function() {
        printWindow.print();
        printWindow.close();
    };
    
    showNotification('Print window opened!', 'success');
}
</script>
{% endblock %} 