{% extends "admin/base_site.html" %}
{% load static %}

{% block title %}Enhanced Result Management - Nawa Prativa{% endblock %}

{% block extrastyle %}
{{ block.super }}
<style>
    .enhanced-result-container {
        padding: 20px;
        background: #f8f9fa;
        min-height: 100vh;
    }
    
    .header-section {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 20px;
    }
    
    .subject-manager {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 20px;
    }
    
    .subject-form {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        align-items: end;
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        border: 1px solid #e9ecef;
    }
    
    .form-group {
        display: flex;
        flex-direction: column;
        gap: 5px;
        position: relative;
    }
    
    .subject-status-container {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        z-index: 1000;
        margin-top: 5px;
    }
    
    .form-group label {
        font-weight: 600;
        color: #333;
    }
    
    .form-group input, .form-group select {
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
    }
    
    .btn {
        padding: 8px 16px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.3s ease;
    }
    
    .btn-primary {
        background: #007bff;
        color: white;
    }
    
    .btn-primary:hover {
        background: #0056b3;
    }
    
    .btn-success {
        background: #28a745;
        color: white;
    }
    
    .btn-success:hover {
        background: #1e7e34;
    }
    
    .btn-warning {
        background: #ffc107;
        color: #212529;
    }
    
    .btn-info {
        background: #17a2b8;
        color: white;
    }
    
    .btn-info:hover {
        background: #138496;
    }
    
    .btn-danger {
        background: #dc3545;
        color: white;
    }
    
    .btn-danger:hover {
        background: #c82333;
    }
    
    .advanced-features {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 20px;
    }
    
    .feature-buttons {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 20px;
    }
    
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
    }
    
    .modal-content {
        background-color: white;
        margin: 5% auto;
        padding: 20px;
        border-radius: 8px;
        width: 80%;
        max-width: 600px;
        max-height: 80vh;
        overflow-y: auto;
    }
    
    .close {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
    }
    
    .close:hover {
        color: #000;
    }
    
    .analytics-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-top: 20px;
    }
    
    .analytics-card {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        text-align: center;
        border: 1px solid #e9ecef;
    }
    
    .analytics-number {
        font-size: 2em;
        font-weight: bold;
        color: #007bff;
    }
    
    .email-form {
        display: grid;
        gap: 15px;
    }
    
    .email-form textarea {
        min-height: 100px;
        resize: vertical;
    }
    
    .btn-warning:hover {
        background: #e0a800;
    }
    
    .btn-danger {
        background: #dc3545;
        color: white;
    }
    
    .btn-danger:hover {
        background: #c82333;
    }
    
    .btn-info {
        background: #17a2b8;
        color: white;
    }
    
    .btn-info:hover {
        background: #138496;
    }
    
    .spreadsheet-container {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        overflow: hidden;
    }
    
    .spreadsheet-header {
        background: #f8f9fa;
        padding: 15px 20px;
        border-bottom: 1px solid #dee2e6;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 10px;
    }
    
    .spreadsheet-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 14px;
    }
    
    .spreadsheet-table th {
        background: #e9ecef;
        padding: 12px 8px;
        text-align: center;
        font-weight: 600;
        border: 1px solid #dee2e6;
        position: sticky;
        top: 0;
        z-index: 10;
    }
    
    .spreadsheet-table td {
        padding: 8px;
        border: 1px solid #dee2e6;
        text-align: center;
    }
    
    .spreadsheet-table input {
        width: 100%;
        padding: 6px;
        border: 1px solid #ddd;
        border-radius: 3px;
        text-align: center;
        font-size: 13px;
    }
    
    .spreadsheet-table input:focus {
        outline: none;
        border-color: #007bff;
        box-shadow: 0 0 0 2px rgba(0,123,255,0.25);
    }
    
    .student-row {
        background: #f8f9fa;
    }
    
    .student-row:hover {
        background: #e9ecef;
    }
    
    .symbol-number {
        font-weight: 600;
        color: #495057;
        background: #e9ecef;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
    }
    
    .result-panel {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-top: 20px;
        display: none;
    }
    
    .result-panel.active {
        display: block;
    }
    
    .result-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid #e9ecef;
    }
    
    .result-summary {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 20px;
    }
    
    .summary-card {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 6px;
        text-align: center;
    }
    
    .summary-card h4 {
        margin: 0 0 5px 0;
        color: #6c757d;
        font-size: 14px;
    }
    
    .summary-card .value {
        font-size: 24px;
        font-weight: 700;
        color: #495057;
    }
    
    .subject-marks-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 15px;
    }
    
    .subject-marks-table th,
    .subject-marks-table td {
        padding: 10px;
        border: 1px solid #dee2e6;
        text-align: center;
    }
    
    .subject-marks-table th {
        background: #e9ecef;
        font-weight: 600;
    }
    
    .grade-a-plus { color: #28a745; font-weight: 600; }
    .grade-a { color: #28a745; font-weight: 600; }
    .grade-b-plus { color: #17a2b8; font-weight: 600; }
    .grade-b { color: #17a2b8; font-weight: 600; }
    .grade-c-plus { color: #ffc107; font-weight: 600; }
    .grade-c { color: #ffc107; font-weight: 600; }
    .grade-d { color: #fd7e14; font-weight: 600; }
    .grade-ng { color: #dc3545; font-weight: 600; }
    
    .status-pass { color: #28a745; font-weight: 600; }
    .status-fail { color: #dc3545; font-weight: 600; }
    .status-conditional { color: #ffc107; font-weight: 600; }
    
    .notification {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 15px 20px;
        border-radius: 6px;
        color: white;
        font-weight: 500;
        z-index: 1000;
        animation: slideIn 0.3s ease;
    }
    
    .notification.success { background: #28a745; }
    .notification.error { background: #dc3545; }
    .notification.info { background: #17a2b8; }
    .notification.warning { 
        background: linear-gradient(135deg, #ffc107 0%, #ff8c00 100%); 
        color: #212529; 
        border-left: 4px solid #e0a800;
    }
    
    @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
    
    .loading {
        opacity: 0.6;
        pointer-events: none;
    }
    
    .auto-save-indicator {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: #28a745;
        color: white;
        padding: 8px 12px;
        border-radius: 4px;
        font-size: 12px;
        display: none;
    }
    
    /* Modal Styles */
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
        animation: fadeIn 0.3s ease;
    }
    
    .modal-content {
        background-color: white;
        margin: 5% auto;
        padding: 0;
        border-radius: 8px;
        width: 90%;
        max-width: 500px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        animation: slideIn 0.3s ease;
    }
    
    .modal-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        border-radius: 8px 8px 0 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .modal-header h3 {
        margin: 0;
        font-size: 18px;
        font-weight: 600;
    }
    
    .close {
        color: white;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
        transition: opacity 0.3s;
    }
    
    .close:hover {
        opacity: 0.7;
    }
    
    .modal-body {
        padding: 30px;
    }
    
    .modal-form {
        display: grid;
        gap: 20px;
    }
    
    .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
    }
    
    .form-field {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }
    
    .form-field label {
        font-weight: 600;
        color: #333;
        font-size: 14px;
    }
    
    .form-field input,
    .form-field select {
        padding: 12px;
        border: 2px solid #e1e5e9;
        border-radius: 6px;
        font-size: 14px;
        transition: border-color 0.3s ease;
    }
    
    .form-field input:focus,
    .form-field select:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    .modal-footer {
        padding: 20px 30px 30px;
        display: flex;
        justify-content: flex-end;
        gap: 15px;
    }
    
    .btn-modal {
        padding: 12px 24px;
        border: none;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .btn-modal-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }
    
    .btn-modal-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }
    
    .btn-modal-secondary {
        background: #f8f9fa;
        color: #6c757d;
        border: 2px solid #e1e5e9;
    }
    
    .btn-modal-secondary:hover {
        background: #e9ecef;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }
    
    @keyframes slideIn {
        from { transform: translateY(-50px); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
    }
    
    .loading-spinner {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid #f3f3f3;
        border-top: 3px solid #667eea;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-right: 8px;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    @media (max-width: 768px) {
        .subject-form {
            flex-direction: column;
            align-items: stretch;
        }
        
        .spreadsheet-header {
            flex-direction: column;
            align-items: stretch;
        }
        
        .spreadsheet-table {
            font-size: 12px;
        }
        
        .spreadsheet-table th,
        .spreadsheet-table td {
            padding: 4px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="enhanced-result-container">
    <!-- Notification Container -->
    <div id="notificationContainer" style="position: fixed; top: 20px; right: 20px; z-index: 9999;"></div>
    <!-- Header Section -->
    <div class="header-section">
        <h1>üéØ Enhanced Result Management System</h1>
        <p>Manage subjects, students, and marks with dynamic spreadsheet functionality</p>
        
        <div style="display: flex; gap: 15px; margin-top: 15px;">
            <button class="btn btn-primary" onclick="addNewStudent()">
                üë§ Add New Student
            </button>
            <button class="btn btn-success" onclick="saveAllResults()">
                üíæ Save All Results
            </button>
            <button class="btn btn-warning" onclick="exportToExcel()">
                üìä Export to Excel
            </button>
            <button class="btn btn-danger" onclick="clearAllData()">
                üóëÔ∏è Clear All
            </button>
            {% if show_enhanced_marks_entry %}
            <a href="{{ enhanced_marks_entry_url }}" class="btn btn-info" style="text-decoration: none; display: inline-block;">
                ‚úèÔ∏è Enhanced Marks Entry
            </a>
            {% endif %}
        </div>
    </div>
    
    <!-- Navigation Section -->
    {% if show_enhanced_marks_entry %}
    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 15px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
                <h3 style="color: white; margin: 0; font-size: 18px;">üìã Result Management Tools</h3>
                <p style="color: rgba(255,255,255,0.9); margin: 5px 0 0 0; font-size: 14px;">Choose your preferred method for managing results</p>
            </div>
            <div style="display: flex; gap: 10px;">
                <a href="." class="btn btn-light" style="background: rgba(255,255,255,0.9); color: #333; text-decoration: none; padding: 8px 16px; border-radius: 4px; font-weight: 500;">
                    üìä Spreadsheet View
                </a>
                <a href="{{ enhanced_marks_entry_url }}" class="btn btn-light" style="background: rgba(255,255,255,0.9); color: #333; text-decoration: none; padding: 8px 16px; border-radius: 4px; font-weight: 500;">
                    ‚úèÔ∏è Enhanced Marks Entry
                </a>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- Advanced Features Section -->
    <div class="advanced-features">
        <h3>üöÄ Advanced Features</h3>
        <div class="feature-buttons">
            <button class="btn btn-info" onclick="showEmailModal()">
                üìß Email Notifications
            </button>
            <button class="btn btn-info" onclick="showBulkOperationsModal()">
                üì• Bulk Operations
            </button>
            <button class="btn btn-info" onclick="showAnalyticsModal()">
                üìà Analytics Dashboard
            </button>
            <button class="btn btn-info" onclick="showGradeCalculator()">
                üßÆ Grade Calculator
            </button>
            <button class="btn btn-info" onclick="printResultCard()">
                üñ®Ô∏è Print Result Card
            </button>
        </div>
    </div>
    
    <!-- Subject Manager -->
    <div class="subject-manager">
        <h3>üìö Subject Management</h3>
        <div class="subject-form">
            <div class="form-group">
                <label for="subjectName">Subject Name</label>
                <input type="text" id="subjectName" placeholder="e.g., English, Mathematics">
            </div>
            <div class="form-group">
                <label for="creditHour">Credit Hour</label>
                <select id="creditHour">
                    <option value="1">1 Credit</option>
                    <option value="2">2 Credits</option>
                    <option value="3" selected>3 Credits</option>
                    <option value="4">4 Credits</option>
                    <option value="5">5 Credits</option>
                </select>
            </div>
            <div class="form-group">
                <label for="theoryTotal">Theory Total</label>
                <input type="number" id="theoryTotal" value="100" min="0" max="200">
            </div>
            <div class="form-group">
                <label for="practicalTotal">Practical Total</label>
                <input type="number" id="practicalTotal" value="0" min="0" max="100">
            </div>
            <button class="btn btn-primary" onclick="addSubject()">
                ‚ûï Add Subject
            </button>
            <button class="btn btn-secondary" onclick="testRealTimeCheck()" style="background: #6c757d; color: white;">
                üîç Test Real-time Check
            </button>
        </div>
        
        <div id="subjectsList" style="margin-top: 20px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h4>Current Subjects:</h4>
                <button class="btn btn-info" onclick="viewAllSubjects()" style="font-size: 12px; padding: 6px 12px;">
                    üìã View All Available Subjects
                </button>
            </div>
            <div id="subjectsContainer"></div>
        </div>
    </div>
    
    <!-- Spreadsheet Section -->
    <div class="spreadsheet-container">
        <div class="spreadsheet-header">
            <div>
                <h3>üìä Results Spreadsheet</h3>
                <p id="spreadsheetInfo">No subjects added yet. Add subjects to start managing results.</p>
            </div>
            <div style="display: flex; gap: 10px;">
                <select id="examType" class="form-group">
                    <option value="Final Term">Final Term</option>
                    <option value="Mid Term">Mid Term</option>
                    <option value="Unit Test">Unit Test</option>
                    <option value="Pre-Board">Pre-Board</option>
                    <option value="Board Exam">Board Exam</option>
                </select>
                <select id="academicYear" class="form-group">
                    <option value="2024-25">2024-25</option>
                    <option value="2023-24">2023-24</option>
                    <option value="2022-23">2022-23</option>
                </select>
            </div>
        </div>
        
        <div style="overflow-x: auto;">
            <table class="spreadsheet-table" id="resultsTable">
                <thead id="tableHeader">
                    <tr>
                        <th>Symbol No.</th>
                        <th>Student Name</th>
                        <th colspan="3">No subjects added</th>
                        <th>Total</th>
                        <th>Percentage</th>
                        <th>Grade</th>
                        <th>GPA</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <tr>
                        <td colspan="11" style="text-align: center; padding: 40px; color: #6c757d;">
                            <p>No students added yet. Click "Add New Student" to start.</p>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- Result Panel -->
    <div class="result-panel" id="resultPanel">
        <div class="result-header">
            <h3>üìã Student Result Details</h3>
            <button class="btn btn-primary" onclick="printResult()">üñ®Ô∏è Print Result</button>
        </div>
        
        <div class="result-summary" id="resultSummary">
            <!-- Summary cards will be populated here -->
        </div>
        
        <div id="resultDetails">
            <!-- Detailed result table will be populated here -->
        </div>
    </div>
</div>

<!-- Student Add Modal -->
<div id="studentModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>üë§ Add New Student</h3>
            <span class="close" onclick="closeStudentModal()">&times;</span>
        </div>
        <div class="modal-body">
            <form class="modal-form" id="studentForm">
                <div class="form-row">
                    <div class="form-field">
                        <label for="studentFullName">Full Name *</label>
                        <input type="text" id="studentFullName" required placeholder="Enter student's full name">
                    </div>
                    <div class="form-field">
                        <label for="studentClass">Class</label>
                        <select id="studentClass">
                            <option value="10">Class 10</option>
                            <option value="9">Class 9</option>
                            <option value="8">Class 8</option>
                            <option value="7">Class 7</option>
                            <option value="6">Class 6</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-field">
                        <label for="studentDOB">Date of Birth</label>
                        <input type="date" id="studentDOB">
                    </div>
                    <div class="form-field">
                        <label for="studentGender">Gender</label>
                        <select id="studentGender">
                            <option value="Male">Male</option>
                            <option value="Female">Female</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-field">
                        <label for="studentEmail">Email</label>
                        <input type="email" id="studentEmail" placeholder="student@example.com">
                    </div>
                    <div class="form-field">
                        <label for="studentPhone">Phone Number</label>
                        <input type="tel" id="studentPhone" placeholder="+977-XXXXXXXXX">
                    </div>
                </div>
                <div class="form-field">
                    <label for="studentAddress">Address</label>
                    <input type="text" id="studentAddress" placeholder="Enter student's address">
                </div>
                <div class="form-row">
                    <div class="form-field">
                        <label for="parentName">Parent/Guardian Name</label>
                        <input type="text" id="parentName" placeholder="Enter parent's name">
                    </div>
                    <div class="form-field">
                        <label for="parentContact">Parent Contact</label>
                        <input type="tel" id="parentContact" placeholder="+977-XXXXXXXXX">
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn-modal btn-modal-secondary" onclick="closeStudentModal()">Cancel</button>
            <button type="button" class="btn-modal btn-modal-primary" onclick="submitStudentForm()" id="submitStudentBtn">
                <span id="submitBtnText">Add Student</span>
            </button>
        </div>
    </div>
</div>

<!-- Auto-save indicator -->
<div class="auto-save-indicator" id="autoSaveIndicator">
    üíæ Auto-saved
</div>

<!-- Notification container -->
<div id="notificationContainer"></div>

<script>
// Global variables
let subjects = [];
let students = [];
let currentStudentData = null;
let autoSaveTimeout = null;

// Initialize the page
document.addEventListener('DOMContentLoaded', function() {
    loadSubjects();
    loadStudents();
    setupEventListeners();
});

// Setup event listeners
function setupEventListeners() {
    // Auto-save on input changes
    document.addEventListener('input', function(e) {
        if (e.target.classList.contains('mark-input')) {
            clearTimeout(autoSaveTimeout);
            autoSaveTimeout = setTimeout(autoSave, 2000); // 2 second debounce
        }
    });
    
    // Keyboard navigation
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && e.target.classList.contains('mark-input')) {
            e.preventDefault();
            const nextInput = e.target.parentElement.nextElementSibling?.querySelector('input');
            if (nextInput) nextInput.focus();
        }
    });
    
    // Modal event listeners
    const modal = document.getElementById('studentModal');
    const closeBtn = document.querySelector('.close');
    
    // Close modal when clicking outside
    window.addEventListener('click', function(e) {
        if (e.target === modal) {
            closeStudentModal();
        }
    });
    
    // Close modal with Escape key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && modal.style.display === 'block') {
            closeStudentModal();
        }
    });
    
    // Form submission with Enter key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && e.target.closest('#studentForm')) {
            e.preventDefault();
            submitStudentForm();
        }
    });
}

// Subject Management Functions
async function addSubject() {
    const name = document.getElementById('subjectName').value.trim();
    const creditHour = parseFloat(document.getElementById('creditHour').value);
    const theoryTotal = parseFloat(document.getElementById('theoryTotal').value);
    const practicalTotal = parseFloat(document.getElementById('practicalTotal').value);
    
    if (!name) {
        showNotification('Please enter a subject name', 'error');
        return;
    }
    
    // Check if subject already exists (case-insensitive)
    const existingSubject = subjects.find(s => s.name.toLowerCase() === name.toLowerCase());
    if (existingSubject) {
        showNotification(`Subject "${existingSubject.name}" already exists`, 'error');
        return;
    }
    
    try {
        const response = await fetch('/api/add-subject/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken(),
            },
            body: JSON.stringify({
                name: name,
                credit_hour: creditHour,
                description: `${name} subject with ${creditHour} credit hours`
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            const subject = {
                id: data.subject.id,
                name: name,
                credit_hour: creditHour,
                theory_total: theoryTotal,
                practical_total: practicalTotal
            };
            
            subjects.push(subject);
            updateSubjectsList();
            updateSpreadsheet();
            
            // Clear form
            document.getElementById('subjectName').value = '';
            document.getElementById('creditHour').value = '3';
            document.getElementById('theoryTotal').value = '100';
            document.getElementById('practicalTotal').value = '0';
            
            showNotification(`Subject "${name}" added successfully`, 'success');
        } else {
            if (data.existing_subject) {
                // Show more detailed error with option to use existing subject
                showNotification(`${data.error}. You can use the existing subject or choose a different name.`, 'warning');
                
                // Optionally, you could add a button to use the existing subject
                const useExistingBtn = document.createElement('button');
                useExistingBtn.textContent = 'Use Existing Subject';
                useExistingBtn.className = 'btn btn-warning';
                useExistingBtn.style.marginLeft = '10px';
                useExistingBtn.onclick = () => {
                    // Add the existing subject to the current session
                    const existingSubject = {
                        id: data.existing_subject.id,
                        name: data.existing_subject.name,
                        credit_hour: data.existing_subject.credit_hour,
                        theory_total: theoryTotal,
                        practical_total: practicalTotal
                    };
                    
                    if (!subjects.some(s => s.id === existingSubject.id)) {
                        subjects.push(existingSubject);
                        updateSubjectsList();
                        updateSpreadsheet();
                        showNotification(`Using existing subject "${existingSubject.name}"`, 'success');
                    } else {
                        showNotification(`Subject "${existingSubject.name}" is already in use`, 'info');
                    }
                };
                
                // Add button to the notification (you might need to adjust this based on your notification system)
                setTimeout(() => {
                    const notifications = document.querySelectorAll('.notification');
                    const lastNotification = notifications[notifications.length - 1];
                    if (lastNotification) {
                        lastNotification.appendChild(useExistingBtn);
                    }
                }, 100);
            } else {
                showNotification(data.error, 'error');
            }
        }
    } catch (error) {
        showNotification('Error adding subject', 'error');
        console.error('Error:', error);
    }
}

async function loadSubjects() {
    try {
        const response = await fetch('/api/subjects/');
        const data = await response.json();
        subjects = data.results || [];
        updateSubjectsList();
        updateSpreadsheet();
    } catch (error) {
        console.error('Error loading subjects:', error);
    }
}

function updateSubjectsList() {
    const container = document.getElementById('subjectsContainer');
    if (subjects.length === 0) {
        container.innerHTML = '<p style="color: #6c757d;">No subjects added yet.</p>';
        return;
    }
    
    container.innerHTML = subjects.map(subject => `
        <div style="display: inline-block; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 10px 15px; margin: 8px; border-radius: 6px; font-size: 14px; box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);">
            üìö ${subject.name} (${subject.credit_hour} credits)
            <button onclick="removeSubject('${subject.name}')" style="background: rgba(255,255,255,0.2); color: white; border: none; border-radius: 3px; padding: 4px 8px; margin-left: 10px; cursor: pointer; transition: background 0.3s;" onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">√ó</button>
        </div>
    `).join('');
}

function removeSubject(subjectName) {
    if (confirm(`Are you sure you want to remove "${subjectName}"? This will also remove all marks for this subject.`)) {
        subjects = subjects.filter(s => s.name !== subjectName);
        updateSubjectsList();
        updateSpreadsheet();
        showNotification(`Subject "${subjectName}" removed`, 'info');
    }
}

async function viewAllSubjects() {
    try {
        const response = await fetch('/api/subjects/');
        const data = await response.json();
        const allSubjects = data.results || [];
        
        let message = `All Available Subjects (${allSubjects.length}):\n\n`;
        allSubjects.forEach(subject => {
            message += `üìö ${subject.name} (${subject.credit_hour} credits) - Code: ${subject.code}\n`;
        });
        
        alert(message);
    } catch (error) {
        showNotification('Error loading subjects', 'error');
        console.error('Error:', error);
    }
}

// Student Management Functions
function addNewStudent() {
    // Reset form
    document.getElementById('studentForm').reset();
    document.getElementById('studentDOB').value = '2000-01-01';
    
    // Show modal
    document.getElementById('studentModal').style.display = 'block';
    document.getElementById('studentFullName').focus();
}

function closeStudentModal() {
    document.getElementById('studentModal').style.display = 'none';
}

async function submitStudentForm() {
    const fullName = document.getElementById('studentFullName').value.trim();
    const studentClass = document.getElementById('studentClass').value;
    const dateOfBirth = document.getElementById('studentDOB').value;
    const gender = document.getElementById('studentGender').value;
    const email = document.getElementById('studentEmail').value.trim();
    const phoneNumber = document.getElementById('studentPhone').value.trim();
    const address = document.getElementById('studentAddress').value.trim();
    const parentName = document.getElementById('parentName').value.trim();
    const parentContact = document.getElementById('parentContact').value.trim();
    
    if (!fullName) {
        showNotification('Please enter student name', 'error');
        document.getElementById('studentFullName').focus();
        return;
    }
    
    // Show loading state
    const submitBtn = document.getElementById('submitStudentBtn');
    const submitBtnText = document.getElementById('submitBtnText');
    submitBtn.disabled = true;
    submitBtnText.innerHTML = '<span class="loading-spinner"></span>Adding Student...';
    
    try {
        const response = await fetch('/api/add-student/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken(),
            },
            body: JSON.stringify({
                full_name: fullName,
                student_class: studentClass,
                date_of_birth: dateOfBirth,
                gender: gender,
                email: email,
                phone_number: phoneNumber,
                address: address,
                parent_name: parentName,
                parent_contact: parentContact
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            const student = {
                id: data.student.id,
                full_name: fullName,
                symbol_number: data.student.symbol_number,
                username: data.student.username
            };
            
            students.push(student);
            updateSpreadsheet();
            showNotification(`Student "${fullName}" added successfully with symbol number ${data.student.symbol_number}`, 'success');
            closeStudentModal();
        } else {
            showNotification(data.error, 'error');
        }
    } catch (error) {
        showNotification('Error adding student', 'error');
        console.error('Error:', error);
    } finally {
        // Reset button state
        submitBtn.disabled = false;
        submitBtnText.textContent = 'Add Student';
    }
}

async function loadStudents() {
    try {
        const response = await fetch('/api/all-students/');
        const data = await response.json();
        students = data || [];
        updateSpreadsheet();
    } catch (error) {
        console.error('Error loading students:', error);
    }
}

// Spreadsheet Functions
function updateSpreadsheet() {
    updateTableHeader();
    updateTableBody();
    updateSpreadsheetInfo();
}

function updateTableHeader() {
    const header = document.getElementById('tableHeader');
    
    if (subjects.length === 0) {
        header.innerHTML = `
            <tr>
                <th>Symbol No.</th>
                <th>Student Name</th>
                <th colspan="3">No subjects added</th>
                <th>Total</th>
                <th>Percentage</th>
                <th>Grade</th>
                <th>GPA</th>
                <th>Status</th>
                <th>Actions</th>
            </tr>
        `;
        return;
    }
    
    let headerHTML = `
        <tr>
            <th rowspan="2">Symbol No.</th>
            <th rowspan="2">Student Name</th>
    `;
    
    subjects.forEach(subject => {
        headerHTML += `
            <th colspan="4" style="text-align: center; background: #e8f5e8;">
                ${subject.name} (${subject.credit_hour} credits)
            </th>
        `;
    });
    
    headerHTML += `
            <th rowspan="2">Total</th>
            <th rowspan="2">Percentage</th>
            <th rowspan="2">Grade</th>
            <th rowspan="2">GPA</th>
            <th rowspan="2">Status</th>
            <th rowspan="2">Actions</th>
        </tr>
        <tr>
    `;
    
    subjects.forEach(subject => {
        headerHTML += `
            <th>Theory</th>
            <th>Practical</th>
            <th>Total</th>
            <th>Grade</th>
        `;
    });
    
    headerHTML += '</tr>';
    header.innerHTML = headerHTML;
}

function updateTableBody() {
    const tbody = document.getElementById('tableBody');
    
    if (students.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="${4 + subjects.length * 4 + 6}" style="text-align: center; padding: 40px; color: #6c757d;">
                    <p>No students added yet. Click "Add New Student" to start.</p>
                </td>
            </tr>
        `;
        return;
    }
    
    tbody.innerHTML = students.map(student => createStudentRow(student)).join('');
}

function createStudentRow(student) {
    let rowHTML = `
        <tr class="student-row" data-student-id="${student.id}">
            <td><span class="symbol-number">${student.symbol_number}</span></td>
            <td>${student.full_name}</td>
    `;
    
    subjects.forEach(subject => {
        rowHTML += `
            <td>
                <input type="number" class="mark-input theory-mark" 
                       data-student="${student.symbol_number}" 
                       data-subject="${subject.name}" 
                       data-type="theory"
                       placeholder="0" min="0" max="${subject.theory_total || 100}"
                       style="width: 60px;">
            </td>
            <td>
                <input type="number" class="mark-input practical-mark" 
                       data-student="${student.symbol_number}" 
                       data-subject="${subject.name}" 
                       data-type="practical"
                       placeholder="0" min="0" max="${subject.practical_total || 0}"
                       style="width: 60px;">
            </td>
            <td class="subject-total" data-student="${student.symbol_number}" data-subject="${subject.name}">0</td>
            <td class="subject-grade" data-student="${student.symbol_number}" data-subject="${subject.name}">-</td>
        `;
    });
    
    rowHTML += `
            <td class="student-total" data-student="${student.symbol_number}">0</td>
            <td class="student-percentage" data-student="${student.symbol_number}">0.00%</td>
            <td class="student-grade" data-student="${student.symbol_number}">-</td>
            <td class="student-gpa" data-student="${student.symbol_number}">0.00</td>
            <td class="student-status" data-student="${student.symbol_number}">-</td>
            <td>
                <button class="btn btn-primary" onclick="viewStudentResult('${student.symbol_number}')" style="font-size: 12px; padding: 4px 8px;">
                    üëÅÔ∏è View
                </button>
                <button class="btn btn-danger" onclick="deleteStudent('${student.symbol_number}')" style="font-size: 12px; padding: 4px 8px;">
                    üóëÔ∏è
                </button>
            </td>
        </tr>
    `;
    
    return rowHTML;
}

function updateSpreadsheetInfo() {
    const info = document.getElementById('spreadsheetInfo');
    if (subjects.length === 0) {
        info.textContent = 'No subjects added yet. Add subjects to start managing results.';
    } else if (students.length === 0) {
        info.textContent = 'No students added yet. Add students to start managing results.';
    } else {
        info.textContent = `Managing ${students.length} students with ${subjects.length} subjects.`;
    }
}

// Mark Calculation Functions
function calculateSubjectTotal(studentSymbol, subjectName) {
    const theoryInput = document.querySelector(`input[data-student="${studentSymbol}"][data-subject="${subjectName}"][data-type="theory"]`);
    const practicalInput = document.querySelector(`input[data-student="${studentSymbol}"][data-subject="${subjectName}"][data-type="practical"]`);
    
    const theory = parseFloat(theoryInput?.value) || 0;
    const practical = parseFloat(practicalInput?.value) || 0;
    const total = theory + practical;
    
    const totalCell = document.querySelector(`.subject-total[data-student="${studentSymbol}"][data-subject="${subjectName}"]`);
    if (totalCell) totalCell.textContent = total;
    
    // Calculate and display grade
    const subject = subjects.find(s => s.name === subjectName);
    if (subject) {
        const maxTotal = (subject.theory_total || 100) + (subject.practical_total || 0);
        const percentage = maxTotal > 0 ? (total / maxTotal) * 100 : 0;
        const grade = getGradeFromPercentage(percentage);
        
        const gradeCell = document.querySelector(`.subject-grade[data-student="${studentSymbol}"][data-subject="${subjectName}"]`);
        if (gradeCell) {
            gradeCell.textContent = grade;
            gradeCell.className = `subject-grade grade-${grade.toLowerCase().replace('+', '-plus')}`;
        }
    }
    
    calculateStudentTotals(studentSymbol);
}

function calculateStudentTotals(studentSymbol) {
    const subjectTotals = Array.from(document.querySelectorAll(`.subject-total[data-student="${studentSymbol}"]`));
    const total = subjectTotals.reduce((sum, cell) => sum + (parseFloat(cell.textContent) || 0), 0);
    
    const totalCell = document.querySelector(`.student-total[data-student="${studentSymbol}"]`);
    if (totalCell) totalCell.textContent = total;
    
    // Calculate percentage
    const subject = subjects[0]; // Use first subject as reference
    if (subject) {
        const maxTotal = subjects.length * ((subject.theory_total || 100) + (subject.practical_total || 0));
        const percentage = maxTotal > 0 ? (total / maxTotal) * 100 : 0;
        
        const percentageCell = document.querySelector(`.student-percentage[data-student="${studentSymbol}"]`);
        if (percentageCell) percentageCell.textContent = percentage.toFixed(2) + '%';
        
        // Calculate grade and GPA
        const grade = getGradeFromPercentage(percentage);
        const gpa = getGPAFromGrade(grade);
        
        const gradeCell = document.querySelector(`.student-grade[data-student="${studentSymbol}"]`);
        if (gradeCell) {
            gradeCell.textContent = grade;
            gradeCell.className = `student-grade grade-${grade.toLowerCase().replace('+', '-plus')}`;
        }
        
        const gpaCell = document.querySelector(`.student-gpa[data-student="${studentSymbol}"]`);
        if (gpaCell) gpaCell.textContent = gpa.toFixed(2);
        
        // Calculate status
        const status = getStatusFromGPA(gpa);
        const statusCell = document.querySelector(`.student-status[data-student="${studentSymbol}"]`);
        if (statusCell) {
            statusCell.textContent = status;
            statusCell.className = `student-status status-${status.toLowerCase().replace(' ', '-')}`;
        }
    }
}

function getGradeFromPercentage(percentage) {
    if (percentage >= 90) return 'A+';
    if (percentage >= 80) return 'A';
    if (percentage >= 70) return 'B+';
    if (percentage >= 60) return 'B';
    if (percentage >= 50) return 'C+';
    if (percentage >= 40) return 'C';
    if (percentage >= 30) return 'D';
    return 'NG';
}

function getGPAFromGrade(grade) {
    const gpaMap = {
        'A+': 4.0, 'A': 3.6, 'B+': 3.2, 'B': 2.8,
        'C+': 2.4, 'C': 2.0, 'D': 1.6, 'NG': 0.0
    };
    return gpaMap[grade] || 0.0;
}

function getStatusFromGPA(gpa) {
    if (gpa >= 3.6) return 'Pass';
    if (gpa >= 2.0) return 'Conditional Pass';
    return 'Fail';
}

// Auto-save functionality
async function autoSave() {
    const indicator = document.getElementById('autoSaveIndicator');
    indicator.style.display = 'block';
    
    try {
        const marksData = collectMarksData();
        if (marksData.length === 0) return;
        
        const response = await fetch('/api/submit-marks/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken(),
            },
            body: JSON.stringify({ marks: marksData })
        });
        
        const data = await response.json();
        if (data.success) {
            setTimeout(() => {
                indicator.style.display = 'none';
            }, 2000);
        }
    } catch (error) {
        console.error('Auto-save error:', error);
        indicator.style.display = 'none';
    }
}

function collectMarksData() {
    const marksData = [];
    const inputs = document.querySelectorAll('.mark-input');
    
    inputs.forEach(input => {
        const value = parseFloat(input.value);
        if (!isNaN(value) && value >= 0) {
            marksData.push({
                student_symbol: input.dataset.student,
                subject_name: input.dataset.subject,
                exam_type: document.getElementById('examType').value,
                academic_year: document.getElementById('academicYear').value,
                theory_marks: input.dataset.type === 'theory' ? value : null,
                practical_marks: input.dataset.type === 'practical' ? value : null,
                theory_total: subjects.find(s => s.name === input.dataset.subject)?.theory_total || 100,
                practical_total: subjects.find(s => s.name === input.dataset.subject)?.practical_total || 0
            });
        }
    });
    
    return marksData;
}

// Save all results
async function saveAllResults() {
    const marksData = collectMarksData();
    if (marksData.length === 0) {
        showNotification('No marks to save', 'warning');
        return;
    }
    
    try {
        const response = await fetch('/api/submit-marks/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken(),
            },
            body: JSON.stringify({ marks: marksData })
        });
        
        const data = await response.json();
        if (data.success) {
            showNotification(data.message, 'success');
        } else {
            showNotification(data.error, 'error');
        }
    } catch (error) {
        showNotification('Error saving results', 'error');
        console.error('Error:', error);
    }
}

// View student result
async function viewStudentResult(symbolNumber) {
    try {
        const response = await fetch(`/api/student-result/${symbolNumber}/`);
        const data = await response.json();
        
        if (response.ok) {
            currentStudentData = data;
            displayStudentResult(data);
        } else {
            showNotification(data.error, 'error');
        }
    } catch (error) {
        showNotification('Error loading student result', 'error');
        console.error('Error:', error);
    }
}

function displayStudentResult(data) {
    const panel = document.getElementById('resultPanel');
    const summary = document.getElementById('resultSummary');
    const details = document.getElementById('resultDetails');
    
    // Update summary
    summary.innerHTML = `
        <div class="summary-card">
            <h4>Total Marks</h4>
            <div class="value">${data.total_marks}</div>
        </div>
        <div class="summary-card">
            <h4>Percentage</h4>
            <div class="value">${data.total_percentage.toFixed(2)}%</div>
        </div>
        <div class="summary-card">
            <h4>Average GPA</h4>
            <div class="value">${data.average_gpa.toFixed(2)}</div>
        </div>
        <div class="summary-card">
            <h4>Status</h4>
            <div class="value status-${data.result_status.toLowerCase().replace(' ', '-')}">${data.result_status}</div>
        </div>
    `;
    
    // Update details table
    if (data.marks && data.marks.length > 0) {
        details.innerHTML = `
            <h4>Subject-wise Marks</h4>
            <table class="subject-marks-table">
                <thead>
                    <tr>
                        <th>Subject</th>
                        <th>Credit Hour</th>
                        <th>Theory</th>
                        <th>Practical</th>
                        <th>Total</th>
                        <th>Percentage</th>
                        <th>Grade</th>
                        <th>Grade Point</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    ${data.marks.map(mark => `
                        <tr>
                            <td>${mark.subject_name}</td>
                            <td>${mark.credit_hour}</td>
                            <td>${mark.theory_marks || '-'}</td>
                            <td>${mark.practical_marks || '-'}</td>
                            <td>${mark.total_marks}</td>
                            <td>${mark.percentage.toFixed(2)}%</td>
                            <td class="grade-${mark.grade.toLowerCase().replace('+', '-plus')}">${mark.grade}</td>
                            <td>${mark.grade_point.toFixed(2)}</td>
                            <td class="status-${mark.is_passed ? 'pass' : 'fail'}">${mark.is_passed ? 'Pass' : 'Fail'}</td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        `;
    } else {
        details.innerHTML = '<p>No marks data available for this student.</p>';
    }
    
    panel.classList.add('active');
    panel.scrollIntoView({ behavior: 'smooth' });
}

// Utility functions
function getCSRFToken() {
    const token = document.querySelector('[name=csrfmiddlewaretoken]');
    return token ? token.value : '';
}

function showNotification(message, type = 'info') {
    const container = document.getElementById('notificationContainer');
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    notification.textContent = message;
    
    container.appendChild(notification);
    
    setTimeout(() => {
        notification.remove();
    }, 5000);
}

function exportToExcel() {
    // Implementation for Excel export
    showNotification('Export functionality will be implemented', 'info');
}

function clearAllData() {
    if (confirm('Are you sure you want to clear all data? This action cannot be undone.')) {
        const inputs = document.querySelectorAll('.mark-input');
        inputs.forEach(input => input.value = '');
        
        // Recalculate totals
        students.forEach(student => {
            calculateStudentTotals(student.symbol_number);
        });
        
        showNotification('All data cleared', 'info');
    }
}

function deleteStudent(symbolNumber) {
    if (confirm(`Are you sure you want to delete student with symbol number ${symbolNumber}?`)) {
        // Implementation for student deletion
        showNotification('Delete functionality will be implemented', 'info');
    }
}

function printResult() {
    if (currentStudentData) {
        window.print();
    } else {
        showNotification('No student result selected', 'warning');
    }
}

// Add event listeners for mark inputs
document.addEventListener('input', function(e) {
    if (e.target.classList.contains('mark-input')) {
        const studentSymbol = e.target.dataset.student;
        const subjectName = e.target.dataset.subject;
        calculateSubjectTotal(studentSymbol, subjectName);
    }
});

// Advanced Features Functions
function showEmailModal() {
    const modal = document.getElementById('emailModal');
    modal.style.display = 'block';
    loadStudentsForEmail();
}

function showBulkOperationsModal() {
    const modal = document.getElementById('bulkOperationsModal');
    modal.style.display = 'block';
}

function showAnalyticsModal() {
    const modal = document.getElementById('analyticsModal');
    modal.style.display = 'block';
    loadAnalytics();
}

function showGradeCalculator() {
    const modal = document.getElementById('gradeCalculatorModal');
    modal.style.display = 'block';
}

function printResultCard() {
    if (currentStudentData) {
        const printWindow = window.open('', '_blank');
        printWindow.document.write(`
            <html>
                <head>
                    <title>Result Card - ${currentStudentData.name}</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        .header { text-align: center; margin-bottom: 30px; }
                        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                        th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
                        th { background-color: #f2f2f2; }
                        .summary { margin-top: 20px; padding: 15px; background: #f9f9f9; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>Nawa Prativa School</h1>
                        <h2>Result Card</h2>
                        <p><strong>Student:</strong> ${currentStudentData.name}</p>
                        <p><strong>Symbol No:</strong> ${currentStudentData.symbol_number}</p>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Subject</th>
                                <th>Theory</th>
                                <th>Practical</th>
                                <th>Total</th>
                                <th>Grade</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${currentStudentData.marks.map(mark => `
                                <tr>
                                    <td>${mark.subject_name}</td>
                                    <td>${mark.theory_marks || '-'}</td>
                                    <td>${mark.practical_marks || '-'}</td>
                                    <td>${mark.total_marks}</td>
                                    <td>${mark.grade}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    <div class="summary">
                        <p><strong>Total Percentage:</strong> ${currentStudentData.total_percentage}%</p>
                        <p><strong>Overall Grade:</strong> ${currentStudentData.overall_grade}</p>
                        <p><strong>GPA:</strong> ${currentStudentData.gpa}</p>
                    </div>
                </body>
            </html>
        `);
        printWindow.document.close();
        printWindow.print();
    } else {
        showNotification('No student result selected', 'warning');
    }
}

function loadStudentsForEmail() {
    const container = document.getElementById('emailStudentsList');
    container.innerHTML = '<p style="color: #666; font-style: italic;">Loading students from database...</p>';
    
    // Fetch all students from the database via API
    fetch('/api/email-students-list/')
        .then(response => response.json())
        .then(data => {
            if (data.students && data.students.length > 0) {
                container.innerHTML = `
                    <div style="margin-bottom: 10px;">
                        <label style="display: flex; align-items: center; margin-bottom: 5px;">
                            <input type="checkbox" id="selectAllStudents" onchange="toggleAllStudents()" style="margin-right: 8px;">
                            <strong>Select All Students (${data.students.length} total)</strong>
                        </label>
                    </div>
                    ${data.students.map(student => `
                        <label style="display: flex; align-items: center; margin-bottom: 5px; padding: 5px; border: 1px solid #eee; border-radius: 4px; background: white;">
                            <input type="checkbox" name="email_students" value="${student.symbol_number}" style="margin-right: 8px;">
                            <span><strong>${student.name}</strong> (${student.symbol_number})</span>
                            ${student.email ? `<small style="color: #666; margin-left: 10px;">${student.email}</small>` : ''}
                        </label>
                    `).join('')}
                `;
            } else {
                container.innerHTML = '<p style="color: #666; font-style: italic;">No students found in database. Please add students first.</p>';
            }
        })
        .catch(error => {
            console.error('Error loading students:', error);
            container.innerHTML = '<p style="color: #dc3545; font-style: italic;">Error loading students. Please try again.</p>';
        });
}

function toggleAllStudents() {
    const selectAll = document.getElementById('selectAllStudents');
    const studentCheckboxes = document.querySelectorAll('input[name="email_students"]');
    
    studentCheckboxes.forEach(checkbox => {
        checkbox.checked = selectAll.checked;
    });
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function loadAnalytics() {
    // Simulate analytics data
    const analyticsData = {
        totalStudents: students.length,
        totalSubjects: subjects.length,
        averagePercentage: 75.5,
        passRate: 85.2,
        topSubject: 'Mathematics',
        topStudent: 'John Doe'
    };
    
    displayAnalytics(analyticsData);
}

function displayAnalytics(data) {
    const container = document.getElementById('analyticsContent');
    container.innerHTML = `
        <div class="analytics-grid">
            <div class="analytics-card">
                <h4>Total Students</h4>
                <div class="analytics-number">${data.totalStudents}</div>
            </div>
            <div class="analytics-card">
                <h4>Total Subjects</h4>
                <div class="analytics-number">${data.totalSubjects}</div>
            </div>
            <div class="analytics-card">
                <h4>Average Percentage</h4>
                <div class="analytics-number">${data.averagePercentage}%</div>
            </div>
            <div class="analytics-card">
                <h4>Pass Rate</h4>
                <div class="analytics-number">${data.passRate}%</div>
            </div>
            <div class="analytics-card">
                <h4>Top Subject</h4>
                <div class="analytics-number">${data.topSubject}</div>
            </div>
            <div class="analytics-card">
                <h4>Top Student</h4>
                <div class="analytics-number">${data.topStudent}</div>
            </div>
        </div>
    `;
}

function sendBulkEmails() {
    const selectedStudents = document.querySelectorAll('input[name="email_students"]:checked');
    if (selectedStudents.length === 0) {
        showNotification('Please select at least one student', 'warning');
        return;
    }
    
    const subject = document.getElementById('emailSubject').value;
    const message = document.getElementById('emailMessage').value;
    
    if (!subject.trim() || !message.trim()) {
        showNotification('Please fill in both subject and message', 'warning');
        return;
    }
    
    const selectedSymbolNumbers = Array.from(selectedStudents).map(cb => cb.value);
    const selectedNames = Array.from(selectedStudents).map(cb => cb.nextElementSibling.textContent);
    
    // Show loading state
    const sendButton = document.querySelector('#emailModal .btn-primary');
    const originalText = sendButton.textContent;
    sendButton.textContent = 'üìß Sending...';
    sendButton.disabled = true;
    
    showNotification(`üìß Preparing to send emails to ${selectedStudents.length} students...`, 'info');
    
    // Send actual emails via API
    const emailPromises = selectedSymbolNumbers.map((symbolNumber, index) => {
        const studentName = selectedNames[index];
        console.log(`Sending email to ${studentName} (${symbolNumber})...`);
        
        return fetch(`/api/send-result-email/${symbolNumber}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                exam_type: 'Final Term',
                academic_year: '2024-25',
                recipient_type: 'student',
                recipient_email: '', // Will use student's email from database
                custom_subject: subject,
                custom_message: message
            })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                console.log(`‚úÖ Email sent successfully to ${studentName}: ${data.message}`);
                return { 
                    success: true, 
                    student: symbolNumber, 
                    studentName: studentName,
                    message: data.message 
                };
            } else {
                console.log(`‚ùå Email failed for ${studentName}: ${data.error}`);
                return { 
                    success: false, 
                    student: symbolNumber, 
                    studentName: studentName,
                    message: data.error || data.message || 'Unknown error'
                };
            }
        })
        .catch(error => {
            console.log(`‚ùå Network error for ${studentName}: ${error.message}`);
            return { 
                success: false, 
                student: symbolNumber, 
                studentName: studentName,
                message: `Network error: ${error.message}`
            };
        });
    });
    
    Promise.all(emailPromises).then(results => {
        // Restore button state
        sendButton.textContent = originalText;
        sendButton.disabled = false;
        
        const successCount = results.filter(r => r.success).length;
        const errorCount = results.filter(r => !r.success).length;
        
        // Show detailed results
        let resultMessage = '';
        if (successCount > 0) {
            resultMessage = `‚úÖ Successfully sent ${successCount} emails!`;
            if (errorCount > 0) {
                resultMessage += ` ‚ùå ${errorCount} failed.`;
            }
            showNotification(resultMessage, 'success');
        } else {
            showNotification(`‚ùå Failed to send emails. Please check student email addresses.`, 'error');
        }
        
        // Log detailed results for debugging
        console.log('üìß Email Results:', results);
        
        // Show detailed breakdown if there are errors
        if (errorCount > 0) {
            const failedStudents = results.filter(r => !r.success);
            console.log('‚ùå Failed emails:', failedStudents);
            
            // Show error details in a more user-friendly way
            setTimeout(() => {
                const errorDetails = failedStudents.map(f => `${f.studentName}: ${f.message}`).join('\n');
                if (errorDetails) {
                    showNotification(`Failed emails:\n${errorDetails}`, 'error');
                }
            }, 1000);
        }
        
        closeModal('emailModal');
    });
}

function importStudents() {
    const fileInput = document.getElementById('studentFile');
    const file = fileInput.files[0];
    if (!file) {
        showNotification('Please select a file', 'warning');
        return;
    }
    
    showNotification('Importing students from file...', 'info');
    // Implementation would go here
}

function exportData() {
    showNotification('Exporting data...', 'info');
    // Implementation would go here
}

function calculateGrade() {
    const marks = parseFloat(document.getElementById('gradeMarks').value);
    const total = parseFloat(document.getElementById('gradeTotal').value);
    
    if (isNaN(marks) || isNaN(total) || total === 0) {
        showNotification('Please enter valid marks and total', 'warning');
        return;
    }
    
    const percentage = (marks / total) * 100;
    let grade = 'NG';
    let gradePoint = 0;
    
    if (percentage >= 90) { grade = 'A+'; gradePoint = 4.0; }
    else if (percentage >= 80) { grade = 'A'; gradePoint = 3.6; }
    else if (percentage >= 70) { grade = 'B+'; gradePoint = 3.2; }
    else if (percentage >= 60) { grade = 'B'; gradePoint = 2.8; }
    else if (percentage >= 50) { grade = 'C+'; gradePoint = 2.4; }
    else if (percentage >= 40) { grade = 'C'; gradePoint = 2.0; }
    else if (percentage >= 35) { grade = 'D'; gradePoint = 1.6; }
    
    document.getElementById('gradeResult').innerHTML = `
        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-top: 15px;">
            <h4>Grade Calculation Result:</h4>
            <p><strong>Percentage:</strong> ${percentage.toFixed(2)}%</p>
            <p><strong>Grade:</strong> ${grade}</p>
            <p><strong>Grade Point:</strong> ${gradePoint.toFixed(1)}</p>
        </div>
    `;
}

// Close modal functions
function closeModal(modalId) {
    document.getElementById(modalId).style.display = 'none';
}

// Close modals when clicking outside
window.onclick = function(event) {
    const modals = document.querySelectorAll('.modal');
    modals.forEach(modal => {
        if (event.target === modal) {
            modal.style.display = 'none';
        }
    });
}
</script>

<!-- Modal Dialogs for Advanced Features -->

<!-- Email Notifications Modal -->
<div id="emailModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal('emailModal')">&times;</span>
        <h3>üìß Email Notifications</h3>
        <div class="email-form">
            <div>
                <label><strong>Select Students:</strong></label>
                <div id="emailStudentsList" style="max-height: 250px; overflow-y: auto; border: 1px solid #ddd; padding: 15px; background: #f9f9f9; border-radius: 4px;">
                    <p style="color: #666; font-style: italic; margin: 0;">Loading students...</p>
                </div>
                <small style="color: #666;">Select one or more students to send result notifications</small>
            </div>
            <div>
                <label><strong>Email Subject:</strong></label>
                <input type="text" id="emailSubject" value="Your Result Card - Nawa Prativa School" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div>
                <label><strong>Email Message:</strong></label>
                <textarea id="emailMessage" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">Dear Student,

Your result card has been prepared. Please find your performance details attached.

Best regards,
Nawa Prativa School</textarea>
            </div>
            <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 15px;">
                <button class="btn btn-secondary" onclick="closeModal('emailModal')">Cancel</button>
                <button class="btn btn-primary" onclick="sendBulkEmails()">üìß Send Emails</button>
            </div>
        </div>
    </div>
</div>

<!-- Bulk Operations Modal -->
<div id="bulkOperationsModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal('bulkOperationsModal')">&times;</span>
        <h3>üì• Bulk Operations</h3>
        <div style="display: grid; gap: 20px;">
            <div>
                <h4>Import Students</h4>
                <p>Upload an Excel file to import multiple students at once.</p>
                <input type="file" id="studentFile" accept=".xlsx,.xls" style="margin: 10px 0;">
                <button class="btn btn-primary" onclick="importStudents()">Import Students</button>
            </div>
            <div>
                <h4>Export Data</h4>
                <p>Export current results data to Excel format.</p>
                <button class="btn btn-success" onclick="exportData()">Export to Excel</button>
            </div>
        </div>
    </div>
</div>

<!-- Analytics Dashboard Modal -->
<div id="analyticsModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal('analyticsModal')">&times;</span>
        <h3>üìà Analytics Dashboard</h3>
        <div id="analyticsContent">
            <!-- Analytics content will be loaded here -->
        </div>
    </div>
</div>

<!-- Grade Calculator Modal -->
<div id="gradeCalculatorModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal('gradeCalculatorModal')">&times;</span>
        <h3>üßÆ Grade Calculator</h3>
        <div style="display: grid; gap: 15px;">
            <div>
                <label>Marks Obtained:</label>
                <input type="number" id="gradeMarks" placeholder="Enter marks obtained" style="width: 100%;">
            </div>
            <div>
                <label>Total Marks:</label>
                <input type="number" id="gradeTotal" placeholder="Enter total marks" style="width: 100%;">
            </div>
            <button class="btn btn-primary" onclick="calculateGrade()">Calculate Grade</button>
            <div id="gradeResult">
                <!-- Grade calculation result will appear here -->
            </div>
        </div>
    </div>
</div>

<!-- Load the enhanced results admin JavaScript -->
<script src="{% static 'admin/js/results_admin.js' %}"></script>

{% endblock %} 